<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="toc.html">Table of contents</a>
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc-header" class="toc-header">Contents:</div>
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc">
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.bat.BATFixedTests</h1>

<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Extras</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Blockchain</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">BoundedN</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Containers</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Serializable</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution.Test</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">QCTest</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">BATCommon</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">BATFixed</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">BATGens</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">BATPrinters</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">BATTestCommon</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">List</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ZArith_base</span>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ListNotations</span>.<br/>

<br/>
<span class="comment">(*&nbsp;--------------------------&nbsp;Tests&nbsp;of&nbsp;the&nbsp;BATFixed&nbsp;Implementation&nbsp;--------------------------&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">fundingStart_</span> := 1.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">fundingEnd_</span> := 4.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">tokenCap_</span> := 101%<span class="id" title="var">N</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">tokenMin_</span> := 78%<span class="id" title="var">N</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">bat_setup</span> := <span class="id" title="var">BATCommon.build_setup</span> <span class="id" title="var">initSupply_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ethFund</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">batFund</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">fundingStart_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">fundingEnd_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exchangeRate_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">tokenCap_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">tokenMin_</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">deploy_bat</span> := <span class="id" title="var">create_deployment</span> 0 <span class="id" title="var">BATFixed.contract</span> <span class="id" title="var">bat_setup</span>.<br/>

<br/>
<span class="comment">(*&nbsp;In&nbsp;the&nbsp;initial&nbsp;chain&nbsp;we&nbsp;transfer&nbsp;some&nbsp;assets&nbsp;to&nbsp;a&nbsp;few&nbsp;accounts,&nbsp;just&nbsp;to&nbsp;make&nbsp;the&nbsp;addresses<br/>
&nbsp;&nbsp;&nbsp;present&nbsp;in&nbsp;the&nbsp;chain&nbsp;state.&nbsp;The&nbsp;amount&nbsp;transferred&nbsp;is&nbsp;irrelevant.&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">token_cb</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">ResultMonad.unpack_result</span> (<span class="id" title="var">TraceGens.add_block</span> <span class="id" title="var">empty_chain</span><br/>
&nbsp;&nbsp;[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_1</span> 10);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_2</span> 7);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_3</span> 6);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_4</span> 10);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">ethFund</span> 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">batFund</span> 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> <span class="id" title="var">deploy_bat</span><br/>
&nbsp;&nbsp;]).<br/>

<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">TestInfo</span> &lt;: <span class="id" title="var">BATGensInfo</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">contract_addr</span> := <span class="id" title="var">contract_base_addr</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">accounts</span> := [<span class="id" title="var">batFund</span>; <span class="id" title="var">ethFund</span>] ++ <span class="id" title="var">test_chain_addrs_5</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">gAccount</span> := <span class="id" title="var">gAddress</span> <span class="id" title="var">accounts</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">bat_addr</span> := <span class="id" title="var">batFund</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">fund_addr</span> := <span class="id" title="var">ethFund</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">accounts_total_balance</span> := 37%<span class="id" title="var">Z</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">trace_length</span> := 7.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">bat_addr_refundable</span> := <span class="id" title="var">false</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">bat_addr_fundable</span> := <span class="id" title="var">false</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">eip20_transactions_before_finalized</span> := <span class="id" title="var">false</span>.<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">TestInfo</span>.<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">MG</span> := <span class="id" title="var">BATGens</span> <span class="id" title="var">TestInfo</span>. <span class="id" title="keyword">Import</span> <span class="id" title="var">MG</span>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">NotationInfo</span> &lt;: <span class="id" title="var">TestNotationParameters</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">gAction</span> := <span class="id" title="var">gBATAction</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_cb</span> := <span class="id" title="var">token_cb</span>.<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">NotationInfo</span>.<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">TN</span> := <span class="id" title="var">TestNotations</span> <span class="id" title="var">NotationInfo</span>. <span class="id" title="keyword">Import</span> <span class="id" title="var">TN</span>.<br/>

<br/>
<span class="comment">(*&nbsp;Test&nbsp;generators&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Sample&nbsp;generator&nbsp;to&nbsp;see&nbsp;quality&nbsp;of&nbsp;generated&nbsp;chains&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Sample&nbsp;(gChain).&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;In&nbsp;BATTests.v&nbsp;we&nbsp;saw&nbsp;that&nbsp;there&nbsp;was&nbsp;a&nbsp;problem&nbsp;with&nbsp;refund&nbsp;actions<br/>
&nbsp;&nbsp;&nbsp;sometimes&nbsp;not&nbsp;being&nbsp;valid&nbsp;even&nbsp;though&nbsp;they&nbsp;should&nbsp;be.<br/>
&nbsp;&nbsp;&nbsp;We&nbsp;expect&nbsp;this&nbsp;problem&nbsp;to&nbsp;be&nbsp;fixed&nbsp;and&nbsp;therefore&nbsp;not&nbsp;get&nbsp;any&nbsp;invalid<br/>
&nbsp;&nbsp;&nbsp;actions&nbsp;from&nbsp;the&nbsp;gBATActionValid&nbsp;generator&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAll&nbsp;(gInvalidActions&nbsp;gBATActionValid)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;x&nbsp;=&gt;&nbsp;collect&nbsp;(snd&nbsp;x)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
10000&nbsp;:<br/>
+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Verify&nbsp;hardness&nbsp;of&nbsp;finalizing&nbsp;BAToken.<br/>
&nbsp;&nbsp;&nbsp;Goal&nbsp;is&nbsp;~&nbsp;2/3&nbsp;of&nbsp;generated&nbsp;chains&nbsp;are&nbsp;finalized&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAllChainBuilders&nbsp;(fun&nbsp;cb&nbsp;=&gt;&nbsp;collect&nbsp;(get_chain_finalized&nbsp;cb)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
&nbsp;&nbsp;7023&nbsp;:&nbsp;true<br/>
&nbsp;&nbsp;2977&nbsp;:&nbsp;false<br/>
&nbsp;&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Check&nbsp;heigh&nbsp;chains&nbsp;produced&nbsp;by&nbsp;the&nbsp;chain&nbsp;generator<br/>
&nbsp;&nbsp;&nbsp;We&nbsp;want&nbsp;the&nbsp;average&nbsp;chain&nbsp;height&nbsp;to&nbsp;be&nbsp;close&nbsp;to&nbsp;full&nbsp;length<br/>
&nbsp;&nbsp;&nbsp;since&nbsp;this&nbsp;is&nbsp;a&nbsp;sign&nbsp;that&nbsp;the&nbsp;generator&nbsp;does&nbsp;not&nbsp;generate&nbsp;<br/>
&nbsp;&nbsp;&nbsp;invalid&nbsp;requests&nbsp;so&nbsp;often&nbsp;that&nbsp;it&nbsp;affects&nbsp;chain&nbsp;quality&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAllChainBuilders&nbsp;(fun&nbsp;cb&nbsp;=&gt;&nbsp;collect&nbsp;(get_chain_height&nbsp;cb)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
&nbsp;&nbsp;9954&nbsp;:&nbsp;9<br/>
&nbsp;&nbsp;19&nbsp;:&nbsp;4<br/>
&nbsp;&nbsp;11&nbsp;:&nbsp;5<br/>
&nbsp;&nbsp;9&nbsp;:&nbsp;6<br/>
&nbsp;&nbsp;3&nbsp;:&nbsp;7<br/>
&nbsp;&nbsp;3&nbsp;:&nbsp;3<br/>
&nbsp;&nbsp;1&nbsp;:&nbsp;1<br/>
&nbsp;&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Verify&nbsp;spread&nbsp;of&nbsp;tokens&nbsp;after&nbsp;funding&nbsp;period&nbsp;is&nbsp;over.<br/>
&nbsp;&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;to&nbsp;see&nbsp;it&nbsp;it&nbsp;possible&nbsp;to&nbsp;hit&nbsp;the&nbsp;funding&nbsp;cap<br/>
&nbsp;&nbsp;&nbsp;and&nbsp;how&nbsp;easy&nbsp;it&nbsp;is&nbsp;to&nbsp;do.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAllChainBuilders&nbsp;(fun&nbsp;cb&nbsp;=&gt;&nbsp;collect&nbsp;(get_chain_tokens&nbsp;cb)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
&nbsp;&nbsp;934&nbsp;:&nbsp;101<br/>
&nbsp;&nbsp;887&nbsp;:&nbsp;86<br/>
&nbsp;&nbsp;873&nbsp;:&nbsp;95<br/>
&nbsp;&nbsp;852&nbsp;:&nbsp;83<br/>
&nbsp;&nbsp;841&nbsp;:&nbsp;89<br/>
&nbsp;&nbsp;802&nbsp;:&nbsp;92<br/>
&nbsp;&nbsp;782&nbsp;:&nbsp;80<br/>
&nbsp;&nbsp;751&nbsp;:&nbsp;98<br/>
&nbsp;&nbsp;686&nbsp;:&nbsp;77<br/>
&nbsp;&nbsp;559&nbsp;:&nbsp;71<br/>
&nbsp;&nbsp;551&nbsp;:&nbsp;74<br/>
&nbsp;&nbsp;451&nbsp;:&nbsp;68<br/>
&nbsp;&nbsp;323&nbsp;:&nbsp;65<br/>
&nbsp;&nbsp;283&nbsp;:&nbsp;62<br/>
&nbsp;&nbsp;161&nbsp;:&nbsp;59<br/>
&nbsp;&nbsp;99&nbsp;:&nbsp;56<br/>
&nbsp;&nbsp;67&nbsp;:&nbsp;53<br/>
&nbsp;&nbsp;50&nbsp;:&nbsp;50<br/>
&nbsp;&nbsp;17&nbsp;:&nbsp;0<br/>
&nbsp;&nbsp;15&nbsp;:&nbsp;47<br/>
&nbsp;&nbsp;10&nbsp;:&nbsp;44<br/>
&nbsp;&nbsp;4&nbsp;:&nbsp;41<br/>
&nbsp;&nbsp;2&nbsp;:&nbsp;38<br/>
&nbsp;&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Local Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">N_scope</span>.<br/>
<span class="comment">(*&nbsp;Only&nbsp;create_tokens&nbsp;should&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{fun&nbsp;state&nbsp;msg&nbsp;=&gt;&nbsp;negb&nbsp;(msg_is_create_tokens&nbsp;state&nbsp;msg)}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{amount_is_zero}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;only&nbsp;accept&nbsp;calls&nbsp;with&nbsp;money&nbsp;in&nbsp;them&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{msg_is_create_tokens}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{amount_is_positive}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;EIP&nbsp;messages&nbsp;and&nbsp;create_tokens&nbsp;should&nbsp;not&nbsp;produce&nbsp;any&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{msg_is_eip_msg&nbsp;|||&nbsp;msg_is_create_tokens}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{produces_no_actions}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;refund&nbsp;and&nbsp;finalize&nbsp;should&nbsp;produce&nbsp;an&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{msg_is_refund&nbsp;|||&nbsp;msg_is_finalize}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{produces_one_action}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Chcker&nbsp;failing&nbsp;if&nbsp;any&nbsp;constants&nbsp;in&nbsp;BAT&nbsp;states&nbsp;are&nbsp;changed&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">constants_unchanged</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;batFund&nbsp;and&nbsp;ethFund&nbsp;addresses&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">fund_deposit_check</span> := <span class="id" title="var">address_eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">fundDeposit</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">fundDeposit</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">bat_deposit_check</span> := <span class="id" title="var">address_eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">batFundDeposit</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">batFundDeposit</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Funding&nbsp;start&nbsp;block&nbsp;and&nbsp;end&nbsp;block&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">funding_start_check</span> := <span class="id" title="var">Nat.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">fundingStart</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">fundingStart</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">funding_end_check</span> := <span class="id" title="var">Nat.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">fundingEnd</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">fundingEnd</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Token&nbsp;exchange&nbsp;rate&nbsp;&nbsp;and&nbsp;initSupply&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">exchange_rate_check</span> := <span class="id" title="var">N.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenExchangeRate</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">tokenExchangeRate</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">init_supply_check</span> := <span class="id" title="var">N.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">initSupply</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">initSupply</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Minimum&nbsp;and&nbsp;maximum&nbsp;token&nbsp;limits&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">creation_cap_check</span> := <span class="id" title="var">N.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenCreationCap</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">tokenCreationCap</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">creation_min_check</span> := <span class="id" title="var">N.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenCreationMin</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">tokenCreationMin</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">checker</span> (<span class="id" title="var">fund_deposit_check</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">bat_deposit_check</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">funding_start_check</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">funding_end_check</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exchange_rate_check</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_supply_check</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">creation_cap_check</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">creation_min_check</span>)<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;No&nbsp;contract&nbsp;calls&nbsp;modify&nbsp;constants&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{fun&nbsp;state&nbsp;msg&nbsp;=&gt;&nbsp;true}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{constants_unchanged}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;create_tokens&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_create_tokens_update_correct</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>) (<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, []), <span class="id" title="var">create_tokens</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_amount</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;token&nbsp;balance&nbsp;of&nbsp;from&nbsp;should&nbsp;be&nbsp;increased&nbsp;by&nbsp;amount&nbsp;*&nbsp;exchangerate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">balance_correct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">N.eqb</span> (<span class="id" title="var">get_balance</span> <span class="id" title="var">new_state</span> <span class="id" title="var">from</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" title="var">get_balance</span> <span class="id" title="var">old_state</span> <span class="id" title="var">from</span>) + (<span class="id" title="var">Z.to_N</span> <span class="id" title="var">amount</span> * <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenExchangeRate</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;total&nbsp;supply&nbsp;field&nbsp;should&nbsp;be&nbsp;increased&nbsp;by&nbsp;amount&nbsp;*&nbsp;exchangerate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_correct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">N.eqb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">new_state</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) + (<span class="id" title="var">Z.to_N</span> <span class="id" title="var">amount</span> * <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenExchangeRate</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">balance_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply_correct</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;create_tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_create_tokens}}&nbsp;contract_base_addr&nbsp;{{post_create_tokens_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">create_tokens_valid</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">create_tokens</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_amount</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">current_slot</span> := <span class="id" title="var">chain</span>.(<span class="id" title="var">current_slot</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;batFund&nbsp;should&nbsp;not&nbsp;be&nbsp;allowed&nbsp;to&nbsp;call&nbsp;create_tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_valid</span> := <span class="id" title="var">negb</span> (<span class="id" title="var">address_eqb</span> <span class="id" title="var">from</span> <span class="id" title="var">batFund</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;only&nbsp;return&nbsp;some&nbsp;if&nbsp;amount&nbsp;is&nbsp;larger&nbsp;than&nbsp;zero&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount_valid</span> := <span class="id" title="var">Z.leb</span> 0 <span class="id" title="var">amount</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;be&nbsp;callable&nbsp;if&nbsp;the&nbsp;token&nbsp;is&nbsp;not&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_valid</span> := <span class="id" title="var">negb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;be&nbsp;callable&nbsp;if&nbsp;the&nbsp;current&nbsp;slot&nbsp;is&nbsp;in&nbsp;the&nbsp;funding&nbsp;period&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">slot_valid</span> := (<span class="id" title="var">old_state</span>.(<span class="id" title="var">fundingStart</span>) &lt;=? <span class="id" title="var">current_slot</span>)%<span class="id" title="var">nat</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">current_slot</span> &lt;=? <span class="id" title="var">old_state</span>.(<span class="id" title="var">fundingEnd</span>))%<span class="id" title="var">nat</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;be&nbsp;callable&nbsp;with&nbsp;an&nbsp;amount&nbsp;that&nbsp;does&nbsp;not&nbsp;cause<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;total_supply&nbsp;to&nbsp;go&nbsp;over&nbsp;the&nbsp;max&nbsp;tokens&nbsp;cap&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_token_amount_valid</span> := (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) + (<span class="id" title="var">Z.to_N</span> <span class="id" title="var">amount</span> * <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenExchangeRate</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;=? <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenCreationCap</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">from_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">amount_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">is_finalized_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">slot_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_token_amount_valid</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;create_tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_create_tokens}}&nbsp;contract_base_addr&nbsp;{{create_tokens_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_create_tokens_safe</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">create_tokens</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;not&nbsp;change&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;token&nbsp;is&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_unchanged</span> := <span class="id" title="var">Bool.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;any&nbsp;accounts&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowances_unchanged</span> := <span class="id" title="var">fmap_eqb</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span> =&gt; <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;must&nbsp;only&nbsp;change&nbsp;the&nbsp;balance&nbsp;of&nbsp;the&nbsp;sender&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_balances_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">from</span>] <span class="id" title="var">N.eqb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">is_finalized_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">allowances_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_balances_unchanged</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;create_tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_create_tokens}}&nbsp;contract_base_addr&nbsp;{{post_create_tokens_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;finalize&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_finalize_update_correct</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;finalize&nbsp;should&nbsp;produce&nbsp;a&nbsp;transfer&nbsp;action&nbsp;*)</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, [<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">to</span> <span class="id" title="var">amount</span>]), <span class="id" title="var">finalize</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_contract_balance</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;If&nbsp;finalize&nbsp;returns&nbsp;some&nbsp;then&nbsp;if&nbsp;the&nbsp;token&nbsp;should&nbsp;be&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_correct</span> := <span class="id" title="var">Bool.eqb</span> <span class="id" title="var">new_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="var">true</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;transfer&nbsp;action&nbsp;produced&nbsp;should&nbsp;transfer&nbsp;to&nbsp;the&nbsp;ethFund&nbsp;address&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_to_correct</span> := <span class="id" title="var">address_eqb</span> <span class="id" title="var">to</span> <span class="id" title="var">ethFund</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;transfer&nbsp;action&nbsp;produced&nbsp;should&nbsp;transfer&nbsp;the&nbsp;entire&nbsp;contract&nbsp;balance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_amount_correct</span> := <span class="id" title="var">Z.eqb</span> <span class="id" title="var">amount</span> <span class="id" title="var">contract_balance</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_to_valid</span> := <span class="id" title="var">negb</span> (<span class="id" title="var">address_is_contract</span> <span class="id" title="var">to</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_amount_valid</span> := <span class="id" title="var">Z.leb</span> <span class="id" title="var">amount</span> <span class="id" title="var">contract_balance</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">is_finalized_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_to_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_amount_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_to_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_amount_valid</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;finalize<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Finalize&nbsp;updates&nbsp;state&nbsp;correct&nbsp;and&nbsp;produces&nbsp;correct&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_finalize}}&nbsp;contract_base_addr&nbsp;{{post_finalize_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">finalize_valid</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">finalize</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_amount</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">current_slot</span> := <span class="id" title="var">chain</span>.(<span class="id" title="var">current_slot</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Only&nbsp;ethFund&nbsp;should&nbsp;be&nbsp;allowed&nbsp;to&nbsp;call&nbsp;finalize&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_valid</span> := <span class="id" title="var">address_eqb</span> <span class="id" title="var">from</span> <span class="id" title="var">ethFund</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalization&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;contract&nbsp;not&nbsp;already&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_valid</span> := <span class="id" title="var">negb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalization&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;funding&nbsp;period&nbsp;is&nbsp;over&nbsp;or&nbsp;we&nbsp;hit&nbsp;the&nbsp;token&nbsp;cap&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">can_finalize_valid</span> := (<span class="id" title="var">old_state</span>.(<span class="id" title="var">fundingEnd</span>) &lt;? <span class="id" title="var">current_slot</span>)%<span class="id" title="var">nat</span> ||<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">N.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenCreationCap</span>) (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalization&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;token&nbsp;amount<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;within&nbsp;valid&nbsp;(tokenCreationMin,&nbsp;tokenCreationCap)&nbsp;range&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_valid</span> := (<span class="id" title="var">N.leb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenCreationMin</span>) (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>)) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">N.leb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenCreationCap</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalize&nbsp;call&nbsp;must&nbsp;not&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount_valid</span> := <span class="id" title="var">Z.eqb</span> <span class="id" title="var">amount</span> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">from_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">is_finalized_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">can_finalize_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">amount_valid</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;finalize<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Finalize&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_finalize}}&nbsp;contract_base_addr&nbsp;{{finalize_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_finalize_safe</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">finalize</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalize&nbsp;should&nbsp;not&nbsp;change&nbsp;allowances&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowances_unchanged</span> := <span class="id" title="var">fmap_eqb</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span> =&gt; <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalize&nbsp;should&nbsp;not&nbsp;change&nbsp;balances&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">balances_unchanged</span> := <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalize&nbsp;should&nbsp;not&nbsp;change&nbsp;total_supply&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_unchanged</span> := <span class="id" title="var">N.eqb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">total_supply</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">allowances_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">balances_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply_unchanged</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;finalize<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Finalize&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_finalize}}&nbsp;contract_base_addr&nbsp;{{post_finalize_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;refund&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_refund_update_correct</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>) (<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, [<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">to</span> <span class="id" title="var">amount</span>]), <span class="id" title="var">refund</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_contract_balance</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_bal_old</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_bal_new</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">eth_to_refund</span> := <span class="id" title="var">Z.of_N</span> (<span class="id" title="var">from_bal_old</span> / (<span class="id" title="var">tokenExchangeRate</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;subtract&nbsp;the&nbsp;refunded&nbsp;account&nbsp;balance&nbsp;from&nbsp;total_supply&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_correct</span> := <span class="id" title="var">N.eqb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" title="var">total_supply</span> <span class="id" title="var">new_state</span>) + <span class="id" title="var">from_bal_old</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;set&nbsp;the&nbsp;refunded&nbsp;account&nbsp;balance&nbsp;to&nbsp;0&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_correct</span> := <span class="id" title="var">N.eqb</span> <span class="id" title="var">from_bal_new</span> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;shoul&nbsp;pay&nbsp;the&nbsp;refunded&nbsp;account&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_to_correct</span> := <span class="id" title="var">address_eqb</span> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;pay&nbsp;account_balance&nbsp;/&nbsp;exchange_rate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_amount_correct</span> := <span class="id" title="var">Z.eqb</span> <span class="id" title="var">amount</span> <span class="id" title="var">eth_to_refund</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_to_valid</span> := <span class="id" title="var">negb</span> (<span class="id" title="var">address_is_contract</span> <span class="id" title="var">to</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Contract&nbsp;should&nbsp;have&nbsp;enough&nbsp;money&nbsp;to&nbsp;refund&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">action_amount_valid</span> := <span class="id" title="var">Z.leb</span> <span class="id" title="var">amount</span> <span class="id" title="var">contract_balance</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">cctx</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">total_supply_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from_balance_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_to_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_amount_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_to_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">action_amount_valid</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;refund<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;False&nbsp;property:&nbsp;Refund&nbsp;updates&nbsp;state&nbsp;correct&nbsp;and&nbsp;produces&nbsp;correct&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_refund}}&nbsp;contract_base_addr&nbsp;{{post_refund_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">refund_valid</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">refund</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">current_slot</span> := <span class="id" title="var">chain</span>.(<span class="id" title="var">current_slot</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_amount</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_bal_old</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;batFund&nbsp;should&nbsp;not&nbsp;be&nbsp;allowed&nbsp;a&nbsp;refund&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_valid</span> := <span class="id" title="var">negb</span> (<span class="id" title="var">address_eqb</span> <span class="id" title="var">from</span> <span class="id" title="var">batFund</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;contract&nbsp;not&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_valid</span> := <span class="id" title="var">negb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;funding&nbsp;period&nbsp;is&nbsp;over&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">current_slot_valid</span> := (<span class="id" title="var">old_state</span>.(<span class="id" title="var">fundingEnd</span>) &lt;? <span class="id" title="var">current_slot</span>)%<span class="id" title="var">nat</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;contract&nbsp;did&nbsp;not&nbsp;hit&nbsp;minimum&nbsp;token&nbsp;goal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_valid</span> := <span class="id" title="var">N.ltb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) <span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenCreationMin</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;shoul&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;sender&nbsp;has&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">balance_valid</span> := <span class="id" title="var">N.ltb</span> 0 <span class="id" title="var">from_bal_old</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;call&nbsp;must&nbsp;not&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount_valid</span> := <span class="id" title="var">Z.eqb</span> <span class="id" title="var">amount</span> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">from_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">is_finalized_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">current_slot_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">balance_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">amount_valid</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;refund<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Refund&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_refund}}&nbsp;contract_base_addr&nbsp;{{refund_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_refund_safe</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">refund</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;not&nbsp;change&nbsp;isFinalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_unchanged</span> := <span class="id" title="var">Bool.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;not&nbsp;change&nbsp;allowances&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowances_unchanged</span> := <span class="id" title="var">fmap_eqb</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span> =&gt; <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;not&nbsp;change&nbsp;other&nbsp;balances&nbsp;than&nbsp;the&nbsp;senders&nbsp;balance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_balances_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">from</span>] <span class="id" title="var">N.eqb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">is_finalized_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">allowances_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_balances_unchanged</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;refund<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Refund&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_refund}}&nbsp;contract_base_addr&nbsp;{{post_refund_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;transfer&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_transfer_update_correct</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>) (<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, []), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.transfer</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">to</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_after</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance_after</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">to</span> (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_to_same</span> := <span class="id" title="var">address_eqb</span> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;subtract&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;"from"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_correct</span> := <span class="id" title="keyword">if</span> <span class="id" title="var">from_to_same</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<span class="id" title="var">from_balance_before</span> =? <span class="id" title="var">from_balance_after</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<span class="id" title="var">from_balance_before</span> =? <span class="id" title="var">from_balance_after</span> + <span class="id" title="var">tokens</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;add&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;"to"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance_correct</span> :=   <span class="id" title="keyword">if</span> <span class="id" title="var">from_to_same</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<span class="id" title="var">to_balance_before</span> =? <span class="id" title="var">to_balance_after</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<span class="id" title="var">to_balance_before</span> + <span class="id" title="var">tokens</span> =? <span class="id" title="var">to_balance_after</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">from_balance_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">to_balance_correct</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer}}&nbsp;contract_base_addr&nbsp;{{post_transfer_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer_valid</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.transfer</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_amount</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;should&nbsp;only&nbsp;return&nbsp;some&nbsp;if&nbsp;"from"&nbsp;has&nbsp;enough&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_valid</span> := <span class="id" title="var">N.leb</span> <span class="id" title="var">tokens</span> <span class="id" title="var">from_balance_before</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;call&nbsp;must&nbsp;not&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount_valid</span> := <span class="id" title="var">Z.eqb</span> <span class="id" title="var">amount</span> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">amount_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from_balance_valid</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer}}&nbsp;contract_base_addr&nbsp;{{transfer_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_transfer_safe</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.transfer</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;should&nbsp;not&nbsp;change&nbsp;the&nbsp;finalization&nbsp;state&nbsp;of&nbsp;the&nbsp;token&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_unchanged</span> := <span class="id" title="var">Bool.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;should&nbsp;not&nbsp;change&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_unchanged</span> := <span class="id" title="var">N.eqb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">total_supply</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;any&nbsp;account&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowances_unchanged</span> := <span class="id" title="var">fmap_eqb</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span> =&gt; <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;only&nbsp;change&nbsp;the&nbsp;balance&nbsp;of&nbsp;from&nbsp;and&nbsp;to&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_balances_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">from</span>; <span class="id" title="var">to</span>] <span class="id" title="var">N.eqb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">is_finalized_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">allowances_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_balances_unchanged</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer}}&nbsp;contract_base_addr&nbsp;{{post_transfer_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;transfer_from&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_transfer_from_update_correct</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>) (<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, []), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.transfer_from</span> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">to</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_after</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance_after</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">to</span> (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate_allowance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">delegate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate_allowance_after</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">delegate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_to_same</span> := <span class="id" title="var">address_eqb</span> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;subtract&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;"from"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_correct</span> := <span class="id" title="keyword">if</span> <span class="id" title="var">from_to_same</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<span class="id" title="var">from_balance_before</span> =? <span class="id" title="var">from_balance_after</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<span class="id" title="var">from_balance_before</span> =? <span class="id" title="var">from_balance_after</span> + <span class="id" title="var">tokens</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;add&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;to&nbsp;the&nbsp;"to"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance_correct</span> :=   <span class="id" title="keyword">if</span> <span class="id" title="var">from_to_same</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<span class="id" title="var">to_balance_before</span> =? <span class="id" title="var">to_balance_after</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<span class="id" title="var">to_balance_before</span> + <span class="id" title="var">tokens</span> =? <span class="id" title="var">to_balance_after</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;subtract&nbsp;the&nbsp;number&nbsp;of&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;delegates&nbsp;allowance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delefate_allowance_correct</span> := <span class="id" title="var">delegate_allowance_before</span> =?<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">delegate_allowance_after</span> + <span class="id" title="var">tokens</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">from_balance_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">to_balance_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">delefate_allowance_correct</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer_from<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer_from&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer_from}}&nbsp;contract_base_addr&nbsp;{{post_transfer_from_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer_from_valid</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.transfer_from</span> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_amount</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate_allowance_before</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">delegate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;only&nbsp;succeed&nbsp;if&nbsp;"from"&nbsp;has&nbsp;enough&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance_valid</span> := <span class="id" title="var">N.leb</span> <span class="id" title="var">tokens</span> <span class="id" title="var">from_balance_before</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;only&nbsp;succeed&nbsp;if&nbsp;"delegate"&nbsp;is&nbsp;allowed<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;transfer&nbsp;the&nbsp;requested&nbsp;amount&nbsp;of&nbsp;tokens&nbsp;on&nbsp;behalf&nbsp;of&nbsp;"from"&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate_allowance_valid</span> := <span class="id" title="var">N.leb</span> <span class="id" title="var">tokens</span> <span class="id" title="var">delegate_allowance_before</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Tranfer_from&nbsp;must&nbsp;not&nbsp;be&nbsp;payable*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount_valid</span> := <span class="id" title="var">Z.eqb</span> <span class="id" title="var">amount</span> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">amount_valid</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from_balance_valid</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer_from<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer_from&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer_from}}&nbsp;contract_base_addr&nbsp;{{transfer_from_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_transfer_from_safe</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.transfer_from</span> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_allowances_before</span> := <span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_allowances_after</span> := <span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;finalization&nbsp;state&nbsp;of&nbsp;the&nbsp;token&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_unchanged</span> := <span class="id" title="var">Bool.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_unchanged</span> := <span class="id" title="var">N.eqb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">total_supply</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;other&nbsp;accounts&nbsp;than&nbsp;from&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_allowances_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">from</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span> =&gt; <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_allowance_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">delegate</span>] <span class="id" title="var">N.eqb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from_allowances_before</span> <span class="id" title="var">from_allowances_after</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;balances&nbsp;of&nbsp;other&nbsp;accounts&nbsp;than&nbsp;from&nbsp;and&nbsp;to&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_balances_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">from</span>; <span class="id" title="var">to</span>] <span class="id" title="var">N.eqb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">is_finalized_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_allowances_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_allowance_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_balances_unchanged</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer_from<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer_from&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer_from}}&nbsp;contract_base_addr&nbsp;{{post_transfer_from_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;approve&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_approve_update_correct</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>) (<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, []), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.approve</span> <span class="id" title="var">delegate</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delegate_allowance_after</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">delegate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Approve&nbsp;should&nbsp;update&nbsp;the&nbsp;allowance&nbsp;of&nbsp;"delegate"&nbsp;correctly&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">delefate_allowance_correct</span> := <span class="id" title="var">delegate_allowance_after</span> =? <span class="id" title="var">tokens</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> <span class="id" title="var">delefate_allowance_correct</span>)<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;approve<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Approve&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_approve}}&nbsp;contract_base_addr&nbsp;{{post_approve_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">approve_valid</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.approve</span> <span class="id" title="var">delegate</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_amount</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Approve&nbsp;must&nbsp;not&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount_valid</span> := <span class="id" title="var">Z.eqb</span> <span class="id" title="var">amount</span> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> <span class="id" title="var">amount_valid</span>)<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;approve<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Approve&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_approve}}&nbsp;contract_base_addr&nbsp;{{approve_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">post_approve_safe</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">old_state</span> : <span class="id" title="var">State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Msg</span>) (<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">tokenMsg</span> (<span class="id" title="var">EIP20Token.approve</span> <span class="id" title="var">delegate</span> <span class="id" title="var">tokens</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from</span> := <span class="id" title="var">cctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_allowances_before</span> := <span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">from_allowances_after</span> := <span class="id" title="var">with_default</span> (@<span class="id" title="var">FMap.empty</span> (<span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">TokenValue</span>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FMap.find</span> <span class="id" title="var">from</span> (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Approve&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;finalization&nbsp;state&nbsp;of&nbsp;the&nbsp;token&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized_unchanged</span> := <span class="id" title="var">Bool.eqb</span> <span class="id" title="var">old_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="var">new_state</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_unchanged</span> := <span class="id" title="var">N.eqb</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">total_supply</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;other&nbsp;accounts&nbsp;than&nbsp;"delegate"&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_allowances_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">from</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span> =&gt; <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> <span class="id" title="var">fmap</span> <span class="id" title="var">fmap'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">allowances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">allowances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">other_allowance_unchanged</span> := <span class="id" title="var">fmap_filter_eqb</span> [<span class="id" title="var">delegate</span>] <span class="id" title="var">N.eqb</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from_allowances_before</span> <span class="id" title="var">from_allowances_after</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;balances&nbsp;of&nbsp;any&nbsp;accounts&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">balances_unchanged</span> := <span class="id" title="var">fmap_eqb</span> <span class="id" title="var">N.eqb</span> (<span class="id" title="var">balances</span> <span class="id" title="var">old_state</span>) (<span class="id" title="var">balances</span> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">whenFail</span> (<span class="id" title="var">show</span> <span class="id" title="var">old_state</span> ++ <span class="id" title="var">nl</span> ++ <span class="id" title="var">show</span> <span class="id" title="var">result_opt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<span class="id" title="var">is_finalized_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_allowances_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">other_allowance_unchanged</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">balances_unchanged</span>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;approve<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Approve&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_approve}}&nbsp;contract_base_addr&nbsp;{{post_approve_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;contract&nbsp;balance&nbsp;tests&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">contract_balance_lower_bound</span> (<span class="id" title="var">cs</span> : <span class="id" title="var">ChainState</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance</span> := <span class="id" title="var">env_account_balances</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized</span> := <span class="id" title="var">cstate</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance_correct</span> := <span class="id" title="var">Z.geb</span> <span class="id" title="var">contract_balance</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Z.of_N</span> (((<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>) - (<span class="id" title="var">initSupply</span> <span class="id" title="var">cstate</span>)) / <span class="id" title="var">cstate</span>.(<span class="id" title="var">tokenExchangeRate</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">is_finalized</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">checker</span> <span class="id" title="var">contract_balance_correct</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Contract&nbsp;balance&nbsp;should&nbsp;always&nbsp;be&nbsp;at&nbsp;least&nbsp;as&nbsp;big&nbsp;as&nbsp;the&nbsp;number&nbsp;of&nbsp;refundable&nbsp;tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;divided&nbsp;by&nbsp;the&nbsp;exhange&nbsp;rate&nbsp;unless&nbsp;the&nbsp;token&nbsp;was&nbsp;successfully&nbsp;funded.<br/>
&nbsp;&nbsp;&nbsp;If&nbsp;this&nbsp;property&nbsp;does&nbsp;not&nbsp;hold&nbsp;then&nbsp;it&nbsp;implies&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;cases&nbsp;where&nbsp;a&nbsp;user<br/>
&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;get&nbsp;a&nbsp;refund&nbsp;should&nbsp;the&nbsp;funding&nbsp;fail.<br/>
&nbsp;&nbsp;&nbsp;The&nbsp;number&nbsp;of&nbsp;refundable&nbsp;tokens&nbsp;is&nbsp;the&nbsp;total_supply&nbsp;-&nbsp;init_supply,&nbsp;i.e.&nbsp;all&nbsp;tokens&nbsp;created<br/>
&nbsp;&nbsp;&nbsp;&nbsp;by&nbsp;users&nbsp;funding&nbsp;the&nbsp;project.<br/>
*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{contract_balance_lower_bound}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">contract_balance_lower_bound'</span> (<span class="id" title="var">cs</span> : <span class="id" title="var">ChainState</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance</span> := <span class="id" title="var">env_account_balances</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalized</span> := <span class="id" title="var">cstate</span>.(<span class="id" title="var">isFinalized</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">bat_fund_balance</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">batFund</span> (<span class="id" title="var">balances</span> <span class="id" title="var">cstate</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance_correct</span> := <span class="id" title="var">Z.geb</span> <span class="id" title="var">contract_balance</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Z.of_N</span> (((<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>) - <span class="id" title="var">bat_fund_balance</span>) / <span class="id" title="var">cstate</span>.(<span class="id" title="var">tokenExchangeRate</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">is_finalized</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">checker</span> <span class="id" title="var">contract_balance_correct</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Since&nbsp;the&nbsp;initial&nbsp;supply&nbsp;belonging&nbsp;to&nbsp;the&nbsp;batFund&nbsp;address&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;refundable<br/>
&nbsp;&nbsp;&nbsp;&nbsp;we&nbsp;should&nbsp;have&nbsp;a&nbsp;stronger&nbsp;lower&nbsp;bound&nbsp;saying&nbsp;that&nbsp;the&nbsp;contract&nbsp;balance&nbsp;should&nbsp;always&nbsp;be<br/>
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;least&nbsp;as&nbsp;big&nbsp;as&nbsp;the&nbsp;(total_supply&nbsp;-&nbsp;batFund_balance)&nbsp;/&nbsp;exhange_rate<br/>
&nbsp;&nbsp;&nbsp;&nbsp;unless&nbsp;the&nbsp;token&nbsp;was&nbsp;successfully&nbsp;funded.<br/>
&nbsp;&nbsp;&nbsp;If&nbsp;this&nbsp;property&nbsp;does&nbsp;not&nbsp;hold&nbsp;but&nbsp;the&nbsp;previous&nbsp;property&nbsp;holds&nbsp;then&nbsp;it&nbsp;implies&nbsp;that<br/>
&nbsp;&nbsp;&nbsp;&nbsp;there&nbsp;is&nbsp;a&nbsp;way&nbsp;that&nbsp;some&nbsp;of&nbsp;the&nbsp;initial&nbsp;supply&nbsp;can&nbsp;be&nbsp;refunded,&nbsp;which&nbsp;then&nbsp;it&nbsp;implies<br/>
&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;cases&nbsp;where&nbsp;a&nbsp;real&nbsp;user&nbsp;will&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;get&nbsp;a&nbsp;refund&nbsp;should&nbsp;the&nbsp;funding&nbsp;fail.<br/>
*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{contract_balance_lower_bound'}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">partially_funded_cb</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">ResultMonad.unpack_result</span> (<span class="id" title="var">TraceGens.add_block</span> <span class="id" title="var">empty_chain</span><br/>
&nbsp;&nbsp;[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_1</span> 10);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_2</span> 7);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_3</span> 6);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_4</span> 10);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> <span class="id" title="var">deploy_bat</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">person_1</span> <span class="id" title="var">person_1</span> (<span class="id" title="var">Blockchain.act_call</span> <span class="id" title="var">contract_base_addr</span> 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((@<span class="id" title="var">serialize</span> <span class="id" title="var">BATCommon.Msg</span> <span class="id" title="var">_</span>) <span class="id" title="var">create_tokens</span>))<br/>
&nbsp;&nbsp;]).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;fully&nbsp;refund&nbsp;from&nbsp;a&nbsp;state<br/>
&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;at&nbsp;least&nbsp;one&nbsp;token&nbsp;was&nbsp;created<br/>
&nbsp;&nbsp;&nbsp;&nbsp;i.e.&nbsp;contract&nbsp;balance&nbsp;=&nbsp;0&nbsp;and&nbsp;token&nbsp;not&nbsp;funded.<br/>
&nbsp;&nbsp;&nbsp;Note&nbsp;that&nbsp;this&nbsp;does&nbsp;not&nbsp;mean&nbsp;that&nbsp;the&nbsp;correct&nbsp;people&nbsp;got&nbsp;refunds<br/>
&nbsp;&nbsp;&nbsp;the&nbsp;tests&nbsp;only&nbsp;states&nbsp;that&nbsp;all&nbsp;money&nbsp;put&nbsp;into&nbsp;the&nbsp;contract&nbsp;was<br/>
&nbsp;&nbsp;&nbsp;refunded,&nbsp;i.e.&nbsp;no&nbsp;money&nbsp;get&nbsp;stuck&nbsp;in&nbsp;the&nbsp;contract&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(partially_funded_cb&nbsp;~~&gt;&nbsp;is_fully_refunded).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Chain{|<br/>
Block&nbsp;1&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">11%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">12%256,</span> <span class="inlinecode">7)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">13%256,</span> <span class="inlinecode">6)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">14%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_deploy</span></span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer</span></span> <span class="inlinecode">19%256</span> <span class="inlinecode">17)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;2&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">13%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">4,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;3&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">14%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">5,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">14%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;4&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">6,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;5&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;6&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">13%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">refund</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">refund</span>)}</span>;<br/>
Block&nbsp;7&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">14%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">refund</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">refund</span>)}</span>;|}<br/>
<br/>
Success&nbsp;-&nbsp;found&nbsp;witness&nbsp;satisfying&nbsp;the&nbsp;predicate!<br/>
+++&nbsp;Failed&nbsp;(as&nbsp;expected)&nbsp;after&nbsp;42&nbsp;tests&nbsp;and&nbsp;0&nbsp;shrinks.&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">can_always_fully_refund</span> (<span class="id" title="var">cs</span> : <span class="id" title="var">ChainState</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">no_actions_from_contract</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">fold_left</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">b</span> <span class="id" title="var">action</span> =&gt; <span class="id" title="var">b</span> &amp;&amp; (<span class="id" title="var">negb</span> (<span class="id" title="var">address_is_contract</span> (<span class="id" title="var">act_from</span> <span class="id" title="var">action</span>))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">chain_state_queue</span> <span class="id" title="var">cs</span>) <span class="id" title="var">true</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance</span> := <span class="id" title="var">env_account_balances</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">bat_fund_balance</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">FMap.find</span> <span class="id" title="var">batFund</span> (<span class="id" title="var">balances</span> <span class="id" title="var">cstate</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance_correct</span> := <span class="id" title="var">Z.leb</span> (<span class="id" title="var">contract_balance</span> * <span class="id" title="var">Z.of_N</span> <span class="id" title="var">cstate</span>.(<span class="id" title="var">tokenExchangeRate</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Z.of_N</span> ((<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>) - <span class="id" title="var">bat_fund_balance</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">no_actions_from_contract</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">cstate</span>.(<span class="id" title="var">isFinalized</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">checker</span> <span class="id" title="var">contract_balance_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Above&nbsp;we&nbsp;showed&nbsp;that&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;completely&nbsp;empty&nbsp;the&nbsp;contract&nbsp;balance,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;however&nbsp;the&nbsp;ideally&nbsp;it&nbsp;should&nbsp;always&nbsp;be&nbsp;possible&nbsp;to&nbsp;empty&nbsp;the&nbsp;contract&nbsp;balance.<br/>
&nbsp;&nbsp;&nbsp;If&nbsp;not&nbsp;then&nbsp;it&nbsp;would&nbsp;mean&nbsp;that&nbsp;money&nbsp;could&nbsp;get&nbsp;stuck&nbsp;contract&nbsp;implying&nbsp;that&nbsp;some<br/>
&nbsp;&nbsp;&nbsp;&nbsp;funded&nbsp;money&nbsp;may&nbsp;not&nbsp;be&nbsp;refundable.<br/>
&nbsp;&nbsp;&nbsp;We&nbsp;know&nbsp;that&nbsp;all&nbsp;accounts&nbsp;except&nbsp;batFund&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;refund&nbsp;so&nbsp;the&nbsp;amount&nbsp;of&nbsp;balance<br/>
&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;we&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;withdraw&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;tokens&nbsp;held&nbsp;by&nbsp;all&nbsp;accounts&nbsp;except<br/>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;those&nbsp;held&nbsp;by&nbsp;batFund&nbsp;(initial&nbsp;supply).<br/>
&nbsp;&nbsp;&nbsp;Thus&nbsp;if&nbsp;"contract_balance&nbsp;*&nbsp;exchange_rate&nbsp;&lt;=&nbsp;total_supply&nbsp;-&nbsp;batFund_tokens"&nbsp;then&nbsp;it&nbsp;should&nbsp;be<br/>
&nbsp;&nbsp;&nbsp;&nbsp;possible&nbsp;to&nbsp;withdraw&nbsp;the&nbsp;entire&nbsp;contract&nbsp;balance.<br/>
*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{can_always_fully_refund}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;finalization&nbsp;tests&nbsp;--------------------&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;finalize&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(token_cb&nbsp;~~&gt;&nbsp;is_finalized).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Chain{|<br/>
Block&nbsp;1&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">11%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">12%256,</span> <span class="inlinecode">7)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">13%256,</span> <span class="inlinecode">6)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">14%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_deploy</span></span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer</span></span> <span class="inlinecode">19%256</span> <span class="inlinecode">17)}</span>;<br/>
Block&nbsp;2&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">3,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">14%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">3,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;3&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">13%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">13%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;4&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">8,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">13%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;5&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;6&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">16%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">finalize</span>)}</span>;|}<br/>
<br/>
Success&nbsp;-&nbsp;found&nbsp;witness&nbsp;satisfying&nbsp;the&nbsp;predicate!<br/>
+++&nbsp;Failed&nbsp;(as&nbsp;expected)&nbsp;after&nbsp;6&nbsp;tests&nbsp;and&nbsp;0&nbsp;shrinks.&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">can_always_finalize</span> <span class="id" title="var">check_setup</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">build_init_cb</span> <span class="id" title="var">setup</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">TraceGens.add_block</span> <span class="id" title="var">empty_chain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_1</span> 10);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_2</span> 7);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_3</span> 6);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">Blockchain.act_transfer</span> <span class="id" title="var">person_4</span> 10);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">build_act</span> <span class="id" title="var">creator</span> <span class="id" title="var">creator</span> (<span class="id" title="var">create_deployment</span> 0 <span class="id" title="var">BATFixed.contract</span> <span class="id" title="var">setup</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;] <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">forAll</span> <span class="id" title="var">gBATSetup</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">setup</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">build_init_cb</span> <span class="id" title="var">setup</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">ResultMonad.Ok</span> <span class="id" title="var">init_cb</span> =&gt; <span class="id" title="var">check_setup</span> <span class="id" title="var">setup</span> <span class="id" title="var">init_cb</span> ==&gt; (<span class="id" title="var">init_cb</span> ~~&gt; <span class="id" title="var">is_finalized</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">ResultMonad.Err</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span> ==&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).<br/>
<span class="comment">(*&nbsp;We&nbsp;would&nbsp;like&nbsp;that&nbsp;BAToken&nbsp;has&nbsp;the&nbsp;property&nbsp;that&nbsp;it&nbsp;is<br/>
&nbsp;&nbsp;&nbsp;&nbsp;always&nbsp;possible&nbsp;to&nbsp;successfully&nbsp;fund&nbsp;the&nbsp;token&nbsp;for&nbsp;any<br/>
&nbsp;&nbsp;&nbsp;&nbsp;setup&nbsp;used&nbsp;when&nbsp;deploying&nbsp;the&nbsp;token&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Extract&nbsp;Constant&nbsp;defNumTests&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;"100".<br/>
QuickChick&nbsp;(expectFailure&nbsp;(can_always_finalize&nbsp;(fun&nbsp;_&nbsp;_&nbsp;=&gt;&nbsp;true))).<br/>
Extract&nbsp;Constant&nbsp;defNumTests&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;"10000".<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">final_is_final</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">token_cb</span> ~~~&gt; <span class="id" title="var">bool_to_option</span> <span class="id" title="var">is_finalized</span> ===&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">checkForAllStatesInTrace</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">cs</span> =&gt; <span class="id" title="var">is_finalized</span> <span class="id" title="var">cs</span>).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;it&nbsp;cannot&nbsp;be&nbsp;undone&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_is_final.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4377&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">can_only_finalize_once</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">chain_gen</span> := <span class="id" title="var">gChain</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">blocks</span> <span class="id" title="var">cb</span> := <span class="id" title="var">trace_states_step_block</span> <span class="id" title="var">cb</span>.(<span class="id" title="var">builder_trace</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_finalize</span> <span class="id" title="var">action</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">action</span>.(<span class="id" title="var">act_body</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Blockchain.act_call</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">ser_msg</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> @<span class="id" title="var">deserialize</span> <span class="id" title="var">Msg</span> <span class="id" title="var">_</span> <span class="id" title="var">ser_msg</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">finalize</span> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">finalize_calls'</span> <span class="id" title="var">block</span> := <span class="id" title="var">fold_left</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">count</span> <span class="id" title="var">action</span> =&gt; <span class="id" title="var">count</span> + <span class="id" title="var">is_finalize</span> <span class="id" title="var">action</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">chain_state_queue</span> <span class="id" title="var">block</span>) 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">finalize_calls</span> <span class="id" title="var">blocks</span> := <span class="id" title="var">fold_left</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">count</span> <span class="id" title="var">block</span> =&gt; <span class="id" title="var">count</span> + <span class="id" title="var">finalize_calls'</span> <span class="id" title="var">block</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">blocks</span> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">forAll</span> <span class="id" title="var">chain_gen</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">cb</span> =&gt; <span class="id" title="var">checker</span> (<span class="id" title="var">finalize_calls</span> (<span class="id" title="var">blocks</span> <span class="id" title="var">cb</span>) &lt;=? 1)).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;possible&nbsp;to&nbsp;finalize&nbsp;more&nbsp;than&nbsp;once&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;can_only_finalize_once.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">final_implies_total_supply_in_range</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_in_range</span> <span class="id" title="var">cs</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">state</span> =&gt; (<span class="id" title="var">tokenMin_</span> &lt;=? (<span class="id" title="var">total_supply</span> <span class="id" title="var">state</span>)) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" title="var">total_supply</span> <span class="id" title="var">state</span>) &lt;=? <span class="id" title="var">tokenCap_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">token_cb</span> ~~~&gt; <span class="id" title="var">bool_to_option</span> <span class="id" title="var">is_finalized</span> ===&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">checkForAllStatesInTrace</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">cs</span> =&gt; <span class="id" title="var">total_supply_in_range</span> <span class="id" title="var">cs</span>).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;then&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;is:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;at&nbsp;least&nbsp;_tokenMin<br/>
&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;no&nbsp;bigger&nbsp;than&nbsp;_tokenCap&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_implies_total_supply_in_range.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4234&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">final_implies_total_supply_constant</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">get_satisfying_state</span> <span class="id" title="var">trace</span> := <span class="id" title="var">last</span> <span class="id" title="var">trace</span> <span class="id" title="var">empty_state</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">get_total_supply</span> <span class="id" title="var">cs</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">state</span> =&gt; <span class="id" title="var">total_supply</span> <span class="id" title="var">state</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">finalized_total_supply</span> <span class="id" title="var">trace</span> := <span class="id" title="var">get_total_supply</span> (<span class="id" title="var">get_satisfying_state</span> <span class="id" title="var">trace</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">token_cb</span> ~~~&gt; <span class="id" title="var">bool_to_option</span> <span class="id" title="var">is_finalized</span> ===&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">checkForAllStatesInTrace</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">pre_trace</span> <span class="id" title="var">cs</span> =&gt; <span class="id" title="var">get_total_supply</span> <span class="id" title="var">cs</span> =? <span class="id" title="var">finalized_total_supply</span> <span class="id" title="var">pre_trace</span>).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;then&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;does&nbsp;not&nbsp;change&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_implies_total_supply_constant.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4092&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">final_implies_contract_balance_is_zero</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">contract_balance_empty</span> <span class="id" title="var">trace</span> <span class="id" title="var">cs</span> := <span class="id" title="var">Z.eqb</span> (<span class="id" title="var">env_account_balances</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span>) 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">token_cb</span> ~~~&gt; <span class="id" title="var">bool_to_option</span> <span class="id" title="var">is_finalized</span> ===&gt; <span class="id" title="var">checkForAllStatesInTrace</span> <span class="id" title="var">contract_balance_empty</span>.<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;then&nbsp;the&nbsp;contract&nbsp;balance&nbsp;is&nbsp;0&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_implies_contract_balance_is_zero.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4147&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;total_supply&nbsp;tests&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">total_supply_bounds</span> (<span class="id" title="var">cs</span> : <span class="id" title="var">ChainState</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">cstate</span> =&gt; <span class="id" title="var">checker</span> (((<span class="id" title="var">initSupply</span> <span class="id" title="var">cstate</span>) &lt;=? (<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>)) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>) &lt;=? <span class="id" title="var">tokenCap_</span>))<br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;is&nbsp;always<br/>
&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;larger&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;the&nbsp;inital&nbsp;supply<br/>
&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;the&nbsp;funding&nbsp;cap<br/>
*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{total_supply_bounds}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">total_supply_eq_sum_balances</span> (<span class="id" title="var">cs</span> : <span class="id" title="var">ChainState</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">balances_list</span> := (<span class="id" title="var">map</span> <span class="id" title="var">snd</span> <span class="id" title="var">o</span> <span class="id" title="var">FMap.elements</span>) (<span class="id" title="var">balances</span> <span class="id" title="var">cstate</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">balances_sum</span> : <span class="id" title="var">N</span> := <span class="id" title="var">fold_left</span> <span class="id" title="var">N.add</span> <span class="id" title="var">balances_list</span> 0%<span class="id" title="var">N</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">checker</span> ((<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>) =? <span class="id" title="var">balances_sum</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;is&nbsp;always&nbsp;equal<br/>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;the&nbsp;sum&nbsp;of&nbsp;all&nbsp;token&nbsp;balances&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{total_supply_eq_sum_balances}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">paid_tokens_modulo_exchange_rate</span> (<span class="id" title="var">cs</span> : <span class="id" title="var">ChainState</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">State</span> <span class="id" title="var">cs</span> <span class="id" title="var">contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">paid_tokens</span> := (<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>) - (<span class="id" title="var">initSupply</span> <span class="id" title="var">cstate</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">Nat.leb</span> <span class="id" title="var">cs</span>.(<span class="id" title="var">current_slot</span>) <span class="id" title="var">fundingEnd_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">checker</span> (0 =? <span class="id" title="var">N.modulo</span> <span class="id" title="var">paid_tokens</span> <span class="id" title="var">exchangeRate_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;We&nbsp;check&nbsp;that&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;minus&nbsp;the&nbsp;inital&nbsp;supply<br/>
&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;a&nbsp;multiple&nbsp;of&nbsp;exchange&nbsp;rate.&nbsp;We&nbsp;have&nbsp;seen&nbsp;that&nbsp;this&nbsp;isn't&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;when&nbsp;refunding&nbsp;is&nbsp;allowed,&nbsp;thus&nbsp;we&nbsp;only&nbsp;test&nbsp;this&nbsp;property<br/>
&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;funding&nbsp;period&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{paid_tokens_modulo_exchange_rate}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
