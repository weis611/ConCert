<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="toc.html">Table of contents</a>
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc-header" class="toc-header">Contents:</div>
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc">
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.crowdfunding.ExecFrameworkIntegration</h1>

<div class="code">
</div>

<div class="doc">
<a name="lab222"></a><h1 class="section">Integration with the execution framework, properties of <span class="inlinecode"><span class="id" title="definition">crowdfunding</span></span></h1>

</div>
<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Embedding</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Misc</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Embedding</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Notations</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Embedding</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">PCUICtoTemplate</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Embedding</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">PCUICTranslate</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Embedding</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">SimpleBlockchain</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Crowdfunding</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Crowdfunding</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Crowdfunding</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">CrowdfundingData</span>.<br/>

<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">String</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Basics</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ZArith</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">List</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ssrbool</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Program.Tactics</span>.<br/>

<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Automation</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Extras</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Blockchain</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ResultMonad</span>.<br/>

<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ListNotations</span>.<br/>

<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">list</span>.<br/>

<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">AcornBlockchain</span> <span class="id" title="var">CrowdfundingContract</span> <span class="id" title="var">CrowdfundingProperties</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">expr_to_tc</span> <span class="id" title="var">Σ</span> := <span class="id" title="var">compose</span> <span class="id" title="var">trans</span> (<span class="id" title="var">expr_to_term</span> <span class="id" title="var">Σ</span>).<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">type_to_tc</span> := <span class="id" title="var">compose</span> <span class="id" title="var">trans</span> <span class="id" title="var">type_to_term</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">global_to_tc</span> := <span class="id" title="var">compose</span> <span class="id" title="var">trans_minductive_entry</span> <span class="id" title="var">trans_global_dec</span>.<br/>

<br/>
<span class="id" title="keyword">Global</span> <span class="id" title="var">Program</span> <span class="id" title="keyword">Instance</span> <span class="id" title="var">CB</span> : <span class="id" title="var">ChainBase</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_chain_base</span> <span class="id" title="var">nat</span> <span class="id" title="var">Nat.eqb</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">Nat.odd</span>. <span class="comment">(*&nbsp;Odd&nbsp;addresses&nbsp;are&nbsp;addresses&nbsp;of&nbsp;contracts&nbsp;:)&nbsp;*)</span><br/>
<span class="id" title="keyword">Next</span> <span class="id" title="keyword">Obligation</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">eapply</span> <span class="id" title="var">NPeano.Nat.eqb_spec</span>.<br/>
<span class="id" title="keyword">Defined</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">to_chain</span> (<span class="id" title="var">sc</span> : <span class="id" title="var">SimpleChain_coq</span>) : <span class="id" title="var">Chain</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> '(<span class="id" title="var">Build_chain_coq</span> <span class="id" title="var">h</span> <span class="id" title="var">s</span> <span class="id" title="var">fh</span>) := <span class="id" title="var">sc</span> <span class="id" title="tactic">in</span> <span class="id" title="var">build_chain</span> <span class="id" title="var">h</span> <span class="id" title="var">s</span> <span class="id" title="var">fh</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">of_chain</span> (<span class="id" title="var">c</span> : <span class="id" title="var">Chain</span>) : <span class="id" title="var">SimpleChain_coq</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> '(<span class="id" title="var">build_chain</span> <span class="id" title="var">h</span> <span class="id" title="var">s</span> <span class="id" title="var">fh</span>) := <span class="id" title="var">c</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Build_chain_coq</span> <span class="id" title="var">h</span> <span class="id" title="var">s</span> <span class="id" title="var">fh</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">to_action_body</span> (<span class="id" title="var">sab</span> : <span class="id" title="var">SimpleActionBody_coq</span>) : <span class="id" title="var">ActionBody</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">sab</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Act_transfer</span> <span class="id" title="var">addr</span> <span class="id" title="var">x</span> =&gt; <span class="id" title="var">act_transfer</span> <span class="id" title="var">addr</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">to_contract_call_context</span> (<span class="id" title="var">scc</span> : <span class="id" title="var">SimpleContractCallContext_coq</span>) : <span class="id" title="var">ContractCallContext</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> '(<span class="id" title="var">Build_ctx_coq</span> <span class="id" title="var">origin</span> <span class="id" title="var">from</span> <span class="id" title="var">contr_addr</span> <span class="id" title="var">contr_bal</span> <span class="id" title="var">am</span>) := <span class="id" title="var">scc</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">build_ctx</span> <span class="id" title="var">origin</span> <span class="id" title="var">from</span> <span class="id" title="var">contr_addr</span> <span class="id" title="var">contr_bal</span> <span class="id" title="var">am</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">of_contract_call_context</span> (<span class="id" title="var">cc</span> : <span class="id" title="var">ContractCallContext</span>) : <span class="id" title="var">SimpleContractCallContext_coq</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> '(<span class="id" title="var">build_ctx</span> <span class="id" title="var">origin</span> <span class="id" title="var">from</span> <span class="id" title="var">contr_addr</span> <span class="id" title="var">contr_bal</span> <span class="id" title="var">am</span>) := <span class="id" title="var">cc</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">Build_ctx_coq</span> <span class="id" title="var">origin</span> <span class="id" title="var">from</span> <span class="id" title="var">contr_addr</span> <span class="id" title="var">contr_bal</span> <span class="id" title="var">am</span>.<br/>

<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">Prelude.Maps</span>.<br/>

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">Serialize</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Hint Rewrite</span> <span class="id" title="var">to_list_of_list</span> <span class="id" title="var">of_list_to_list</span> : <span class="id" title="var">hints</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Global</span> <span class="id" title="var">Program</span> <span class="id" title="keyword">Instance</span> <span class="id" title="var">addr_map_serialize</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">addr_map_coq</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{| <span class="id" title="var">serialize</span> <span class="id" title="var">m</span> := <span class="id" title="var">serialize</span> (<span class="id" title="var">to_list</span> <span class="id" title="var">m</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">deserialize</span> <span class="id" title="var">l</span> := <span class="id" title="var">option_map</span> <span class="id" title="var">of_list</span> (<span class="id" title="var">deserialize</span> <span class="id" title="var">l</span>); |}.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Next</span> <span class="id" title="keyword">Obligation</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">cbn</span>. <span class="id" title="tactic">rewrite</span> <span class="id" title="var">deserialize_serialize</span>. <span class="id" title="var">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">autorewrite</span> <span class="id" title="keyword">with</span> <span class="id" title="var">hints</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">State_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">State_coq</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">State_coq_rect</span>&lt;<span class="id" title="var">mkState_coq</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">Msg_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">Msg_coq</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">Msg_coq_rect</span>&lt;<span class="id" title="var">Donate_coq</span>, <span class="id" title="var">GetFunds_coq</span>, <span class="id" title="var">Claim_coq</span>&gt;.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">Serialize</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab223"></a><h2 class="section">Wrappers</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">Wrappers</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">Setup</span> := (<span class="id" title="var">nat</span> * <span class="id" title="var">Z</span>)%<span class="id" title="keyword">type</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_wrapper</span> (<span class="id" title="var">f</span> : <span class="id" title="var">SimpleContractCallContext_coq</span> -&gt; <span class="id" title="var">nat</span> -&gt; <span class="id" title="var">Z</span> -&gt; <span class="id" title="var">State_coq</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Chain</span> -&gt; <span class="id" title="var">ContractCallContext</span> -&gt; <span class="id" title="var">Setup</span> -&gt; <span class="id" title="var">option</span> <span class="id" title="var">State_coq</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id" title="keyword">fun</span> <span class="id" title="var">c</span> <span class="id" title="var">cc</span> <span class="id" title="var">setup</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">f</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">cc</span>) (<span class="id" title="var">fst</span> <span class="id" title="var">setup</span>) (<span class="id" title="var">snd</span> <span class="id" title="var">setup</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">wrapped_init</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">Chain</span> -&gt; <span class="id" title="var">ContractCallContext</span> -&gt; <span class="id" title="var">Setup</span> -&gt; <span class="id" title="var">option</span> <span class="id" title="var">State_coq</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id" title="var">init_wrapper</span> <span class="id" title="var">Init.init</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">receive_wrapper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">f</span> : <span class="id" title="var">SimpleChain_coq</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">SimpleContractCallContext_coq</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Msg_coq</span> -&gt; <span class="id" title="var">State_coq</span> -&gt; <span class="id" title="var">option</span> (<span class="id" title="var">State_coq</span> * <span class="id" title="var">list</span> <span class="id" title="var">SimpleActionBody_coq</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Chain</span> -&gt; <span class="id" title="var">ContractCallContext</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">State_coq</span> -&gt; <span class="id" title="var">option</span> <span class="id" title="var">Msg_coq</span> -&gt; <span class="id" title="var">option</span> (<span class="id" title="var">State_coq</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">ch</span> <span class="id" title="var">cc</span> <span class="id" title="var">st</span> <span class="id" title="var">msg</span> =&gt; <span class="id" title="keyword">match</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> <span class="id" title="var">msg'</span> =&gt; <span class="id" title="var">option_map</span> (<span class="id" title="keyword">fun</span> '(<span class="id" title="var">st0</span>,<span class="id" title="var">acts</span>) =&gt; (<span class="id" title="var">st0</span>, <span class="id" title="var">map</span> <span class="id" title="var">to_action_body</span> <span class="id" title="var">acts</span>)) (<span class="id" title="var">f</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">ch</span>) (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">cc</span>) <span class="id" title="var">msg'</span> <span class="id" title="var">st</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">wrapped_receive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">Chain</span> -&gt; <span class="id" title="var">ContractCallContext</span> -&gt; <span class="id" title="var">State_coq</span> -&gt; <span class="id" title="var">option</span> <span class="id" title="var">Msg_coq</span> -&gt; <span class="id" title="var">option</span> (<span class="id" title="var">State_coq</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id" title="var">receive_wrapper</span> <span class="id" title="var">Receive.receive</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">Wrappers</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">cf_contract</span> : <span class="id" title="var">Contract</span> <span class="id" title="var">Setup</span> <span class="id" title="var">Msg_coq</span> <span class="id" title="var">State_coq</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_contract</span> <span class="id" title="var">wrapped_init</span> <span class="id" title="var">wrapped_receive</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">cf_state</span> (<span class="id" title="var">env</span> : <span class="id" title="var">Environment</span>) (<span class="id" title="var">address</span> : <span class="id" title="var">Blockchain.Address</span>) : <span class="id" title="var">option</span> <span class="id" title="var">State_coq</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">env_contract_states</span> <span class="id" title="var">env</span> <span class="id" title="var">address</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">sv</span> =&gt; <span class="id" title="var">deserialize</span> <span class="id" title="var">sv</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">Lia</span>.<br/>

<br/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">Current_slot_of_chain_eq</span> <span class="id" title="var">ch</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">Current_slot</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">ch</span>) = <span class="id" title="var">current_slot</span> <span class="id" title="var">ch</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">destruct</span> <span class="id" title="var">ch</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">cf_balance_consistent_deadline</span> <span class="id" title="var">bstate</span> <span class="id" title="var">caddr</span> <span class="id" title="var">lstate</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">reachable</span> <span class="id" title="var">bstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">caddr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">cf_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">caddr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">consistent_balance_deadline</span> (<span class="id" title="var">Current_slot</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">bstate</span>)) <span class="id" title="var">lstate</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Hr</span> <span class="id" title="var">Hc</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">Hreceive</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">forall</span> <span class="id" title="var">chain</span> <span class="id" title="var">ctx</span> <span class="id" title="var">prev_state</span> <span class="id" title="var">msg</span> <span class="id" title="var">new_state</span> <span class="id" title="var">new_acts</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wrapped_receive</span> <span class="id" title="var">chain</span> <span class="id" title="var">ctx</span> <span class="id" title="var">prev_state</span> <span class="id" title="var">msg</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">new_acts</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">consistent_balance_deadline</span> (<span class="id" title="var">current_slot</span> <span class="id" title="var">chain</span>) <span class="id" title="var">prev_state</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">consistent_balance_deadline</span> (<span class="id" title="var">current_slot</span> <span class="id" title="var">chain</span>) <span class="id" title="var">new_state</span>).<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">chain</span> <span class="id" title="var">ctx</span> <span class="id" title="var">prev_state</span> <span class="id" title="var">msg</span> <span class="id" title="var">new_state</span> <span class="id" title="var">new_acts</span> <span class="id" title="var">receive</span> <span class="id" title="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span> | ];<span class="id" title="var">tryfalse</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> <span class="id" title="var">receive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> [[? ?] | ] <span class="id" title="var">eqn</span>:<span class="id" title="var">Hreceive</span>;<span class="id" title="var">tryfalse</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">contract_backed</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">chain</span>) (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">ctx</span>) <span class="id" title="var">msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> <span class="id" title="var">Hnew_consistent</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <span class="id" title="var">Current_slot_of_chain_eq</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">Hnew_consistent</span> <span class="id" title="var">_</span> <span class="id" title="var">IH</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">Hnew_consistent</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">fin</span> [<span class="id" title="var">out</span> [<span class="id" title="var">Hrun</span> <span class="id" title="var">Hcon</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">run</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hrun</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <span class="id" title="var">Hreceive</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hrun</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> <span class="id" title="var">new_state</span> <span class="id" title="keyword">with</span> <span class="id" title="var">fin</span> <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id" title="var">enough</span> (<span class="id" title="var">H</span>: <span class="id" title="tactic">exists</span> <span class="id" title="var">lstate'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">caddr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">consistent_balance_deadline</span> (<span class="id" title="var">Current_slot</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">bstate</span>)) <span class="id" title="var">lstate'</span>).<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">lstate'</span> [? ?]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">lstate</span> <span class="id" title="keyword">with</span> <span class="id" title="var">lstate'</span> <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>. }<br/>
<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <span class="id" title="var">Current_slot_of_chain_eq</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="var">contract_induction</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intro</span> <span class="id" title="var">before_deadline</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">AddBlockFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">old_slot</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">new_slot</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">new_slot</span> &gt; <span class="id" title="var">old_slot</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">AddBlockFacts</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> <span class="id" title="var">facts</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">deadline_passed</span> <span class="id" title="tactic">in</span> *. <span class="id" title="tactic">unfold</span> <span class="id" title="var">is_true</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <span class="id" title="var">Bool.negb_true_iff</span> <span class="id" title="tactic">in</span> *. <span class="id" title="var">propify</span>. <span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intros</span> <span class="id" title="var">before_deadline</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">init_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">eauto</span> <span class="id" title="keyword">using</span> <span class="id" title="var">Hreceive</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">eauto</span> <span class="id" title="keyword">using</span> <span class="id" title="var">Hreceive</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">instantiate</span> (<span class="id" title="var">DeployFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">CallFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unset_all</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">destruct_chain_step</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">inversion</span> <span class="id" title="var">valid_header</span>; <span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">destruct</span> <span class="id" title="tactic">eval</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab224"></a><h2 class="section">Contract balance in the local state consistent with the sum of individual contributions</h2>

</div>
<div class="code">
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">cf_balance_consistent</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> <span class="id" title="var">lstate</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">reachable</span> <span class="id" title="var">bstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">cf_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">consistent_balance</span> <span class="id" title="var">lstate</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">reachable</span> <span class="id" title="var">deployed</span> <span class="id" title="var">state_eq</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">enough</span> (<span class="id" title="var">H</span>: <span class="id" title="tactic">exists</span> <span class="id" title="var">lstate'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">consistent_balance</span> <span class="id" title="var">lstate'</span>).<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">lstate'</span> [<span class="id" title="var">lstate'_eq</span> <span class="id" title="var">lstate'_consistent</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">lstate</span> <span class="id" title="keyword">with</span> <span class="id" title="var">lstate'</span> <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">contract_induction</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intro</span> <span class="id" title="var">not_done</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">init_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span>| ]; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_chain</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_ctx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">contract_state_consistent</span> <span class="id" title="var">simple_chain</span> <span class="id" title="var">simple_ctx</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg</span> <span class="id" title="var">prev_state</span> <span class="id" title="var">IH</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> [<span class="id" title="var">fin</span> [<span class="id" title="var">out</span> [<span class="id" title="var">Hrun</span> <span class="id" title="var">Hcon</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">run</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hrun</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> [[<span class="id" title="var">resp_state</span> <span class="id" title="var">resp_acts</span>]| ] <span class="id" title="var">eqn</span>:<span class="id" title="var">Hreceive</span>;<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">new_state</span> <span class="id" title="keyword">with</span> <span class="id" title="var">fin</span> <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span>| ]; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_chain</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_ctx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">contract_state_consistent</span> <span class="id" title="var">simple_chain</span> <span class="id" title="var">simple_ctx</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg</span> <span class="id" title="var">prev_state</span> <span class="id" title="var">IH</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> [<span class="id" title="var">fin</span> [<span class="id" title="var">out</span> [<span class="id" title="var">Hrun</span> <span class="id" title="var">Hcon</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">run</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hrun</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> [[<span class="id" title="var">resp_state</span> <span class="id" title="var">resp_acts</span>]| ] <span class="id" title="var">eqn</span>:<span class="id" title="var">Hreceive</span>;<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">new_state</span> <span class="id" title="keyword">with</span> <span class="id" title="var">fin</span> <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">instantiate</span> (<span class="id" title="var">AddBlockFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">DeployFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">CallFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unset_all</span>; <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">step</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">a</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">undeployed_balance_0</span> (<span class="id" title="var">bstate</span> : <span class="id" title="var">ChainState</span>) <span class="id" title="var">addr</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">reachable</span> <span class="id" title="var">bstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">address_is_contract</span> <span class="id" title="var">addr</span> = <span class="id" title="var">true</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">addr</span> = <span class="id" title="var">None</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" title="var">env_account_balances</span> <span class="id" title="var">bstate</span> <span class="id" title="var">addr</span> = 0%<span class="id" title="var">Z</span>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> [<span class="id" title="var">trace</span>] <span class="id" title="var">is_contract</span> <span class="id" title="var">no_contract</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> (<span class="id" title="var">account_balance_trace</span> <span class="id" title="var">_</span> <span class="id" title="var">trace</span>); <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <span class="id" title="var">undeployed_contract_no_out_txs</span>, <span class="id" title="var">undeployed_contract_no_in_txs</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">contract_no_created_blocks</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">cf_not_sending_deploy_or_call</span> (<span class="id" title="var">bstate</span> : <span class="id" title="var">ChainState</span>) <span class="id" title="var">addr</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">reachable</span> <span class="id" title="var">bstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">addr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">cf_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">Forall</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">a</span> =&gt; ~~<span class="id" title="var">is_deploy</span> <span class="id" title="var">a</span> &amp;&amp; ~~<span class="id" title="var">is_call</span> <span class="id" title="var">a</span>) (<span class="id" title="var">outgoing_acts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">addr</span>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">receive_only_transfer</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">forall</span> <span class="id" title="var">chain</span> <span class="id" title="var">ctx</span> <span class="id" title="var">cstate</span> <span class="id" title="var">msg</span> <span class="id" title="var">new_cstate</span> <span class="id" title="var">acts</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wrapped_receive</span> <span class="id" title="var">chain</span> <span class="id" title="var">ctx</span> <span class="id" title="var">cstate</span> <span class="id" title="var">msg</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">new_cstate</span>, <span class="id" title="var">acts</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Forall</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">a</span> =&gt; ~~ <span class="id" title="var">is_deploy</span> <span class="id" title="var">a</span> &amp;&amp; ~~ <span class="id" title="var">is_call</span> <span class="id" title="var">a</span>) <span class="id" title="var">acts</span>).<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span> ? ? ? ? ? ? <span class="id" title="var">receive_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span> | ];<span class="id" title="var">tryfalse</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> [[? ?] | ] <span class="id" title="var">eqn</span>:<span class="id" title="var">Hreceive</span>;<span class="id" title="var">tryfalse</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> <span class="id" title="var">acts</span> <span class="id" title="keyword">with</span> (<span class="id" title="var">map</span> <span class="id" title="var">to_action_body</span> <span class="id" title="var">l</span>) <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;donate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">destruct_match</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hreceive</span>; <span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">destruct_match</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hreceive</span>; <span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">Hreceive</span>; <span class="id" title="var">cbn</span>; <span class="id" title="var">easy</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;get_funds&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">destruct_match</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hreceive</span>; <span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">Hreceive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;claim&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">destruct_match</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hreceive</span>; <span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">destruct_match</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hreceive</span>; <span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">Hreceive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Hr</span> <span class="id" title="var">Hc</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">contract_induction</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">IH</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">apply</span> <span class="id" title="var">Forall_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">split</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">eauto</span> <span class="id" title="keyword">using</span> <span class="id" title="var">receive_only_transfer</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">apply</span> <span class="id" title="var">Forall_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">IH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">split</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">eauto</span> <span class="id" title="keyword">using</span> <span class="id" title="var">receive_only_transfer</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="var">now</span> <span class="id" title="tactic">rewrite</span> &lt;- <span class="id" title="var">perm</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">instantiate</span> (<span class="id" title="var">AddBlockFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">DeployFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">CallFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unset_all</span>; <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">step</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">a</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Local Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">nat</span>.<br/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">lookup_map_sum_map_leq</span> <span class="id" title="var">m</span> <span class="id" title="var">k</span> <span class="id" title="var">z</span>:<br/>
&nbsp;&nbsp;<span class="id" title="var">map_forallb</span> (<span class="id" title="var">Z.leb</span> 0) <span class="id" title="var">m</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">lookup_map</span> <span class="id" title="var">m</span> <span class="id" title="var">k</span> = <span class="id" title="var">Some</span> <span class="id" title="var">z</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" title="var">z</span> &lt;= <span class="id" title="var">sum_map</span> <span class="id" title="var">m</span>)%<span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">revert</span> <span class="id" title="var">k</span> <span class="id" title="var">z</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">m</span>;<span class="id" title="tactic">intros</span> <span class="id" title="var">k</span> <span class="id" title="var">z0</span> <span class="id" title="var">Hsum</span> <span class="id" title="var">Hlook</span>;<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> *. <span class="id" title="tactic">unfold</span> <span class="id" title="var">is_true</span> <span class="id" title="tactic">in</span> *;<span class="id" title="tactic">repeat</span> <span class="id" title="tactic">rewrite</span> <span class="id" title="var">Bool.andb_true_iff</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">Hsum</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">H1</span> <span class="id" title="var">H2</span>].<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">k</span> =? <span class="id" title="var">n</span>).<br/>
&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> *. <span class="id" title="tactic">inversion</span> <span class="id" title="var">Hlook</span>;<span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">is_true</span> <span class="id" title="tactic">in</span> *;<span class="id" title="tactic">repeat</span> <span class="id" title="tactic">rewrite</span> <span class="id" title="var">Bool.andb_true_iff</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> &lt;- <span class="id" title="var">Zle_is_le_bool</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">sum_map</span> <span class="id" title="var">m</span> &gt;=0)%<span class="id" title="var">Z</span> <span class="id" title="tactic">by</span> <span class="id" title="var">now</span> <span class="id" title="tactic">eapply</span> <span class="id" title="var">all_non_neg_sum_map</span>. <span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;+ <span class="id" title="var">specialize_hypotheses</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">sum_map</span> <span class="id" title="var">m</span> &gt;=0)%<span class="id" title="var">Z</span> <span class="id" title="tactic">by</span> <span class="id" title="var">now</span> <span class="id" title="tactic">eapply</span> <span class="id" title="var">all_non_neg_sum_map</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> &lt;- <span class="id" title="var">Zle_is_le_bool</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">crowfunding_donations_non_negative</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> <span class="id" title="var">lstate</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">reachable</span> <span class="id" title="var">bstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">cf_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">donations_non_neg</span> <span class="id" title="var">lstate</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">reachable</span> <span class="id" title="var">deployed</span> <span class="id" title="var">state_eq</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">enough</span> (<span class="id" title="var">H</span>: <span class="id" title="tactic">exists</span> <span class="id" title="var">lstate'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">donations_non_neg</span> <span class="id" title="var">lstate'</span>).<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">lstate'</span> [<span class="id" title="var">lstate'_eq</span> <span class="id" title="var">lstate'_consistent</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">lstate</span> <span class="id" title="keyword">with</span> <span class="id" title="var">lstate'</span> <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>. }<br/>
<br/>
&nbsp;&nbsp;<span class="id" title="var">contract_induction</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">init_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span>| ]; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">CallFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">ctx</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; (0 &lt;= <span class="id" title="var">Ctx_amount</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">ctx</span>))%<span class="id" title="var">Z</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">CallFacts</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_chain</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_ctx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">contract_state_donation_non_neg</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">simple_chain</span> <span class="id" title="var">simple_ctx</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">ltac</span>:(<span class="id" title="tactic">auto</span>) <span class="id" title="var">prev_state</span> <span class="id" title="var">IH</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> [<span class="id" title="var">fin</span> [<span class="id" title="var">out</span> [<span class="id" title="var">Hrun</span> <span class="id" title="var">Hcon</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">run</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hrun</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> [[<span class="id" title="var">resp_state</span> <span class="id" title="var">resp_acts</span>]| ]; <span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">fin</span> <span class="id" title="keyword">with</span> <span class="id" title="var">new_state</span> <span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span>| ]; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">CallFacts</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_chain</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_chain</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">remember</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">simple_ctx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">contract_state_donation_non_neg</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">simple_chain</span> <span class="id" title="var">simple_ctx</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">ltac</span>:(<span class="id" title="tactic">auto</span>) <span class="id" title="var">prev_state</span> <span class="id" title="var">IH</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> [<span class="id" title="var">fin</span> [<span class="id" title="var">out</span> [<span class="id" title="var">Hrun</span> <span class="id" title="var">Hcon</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">run</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hrun</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> [[<span class="id" title="var">resp_state</span> <span class="id" title="var">resp_acts</span>]| ]; <span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">fin</span> <span class="id" title="keyword">with</span> <span class="id" title="var">new_state</span> <span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">instantiate</span> (<span class="id" title="var">AddBlockFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">DeployFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unset_all</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">step</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">a</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>; <span class="id" title="var">lia</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Lemma</span> <span class="id" title="var">cf_transfer_cases</span> {<span class="id" title="var">sch</span> <span class="id" title="var">sctx</span> <span class="id" title="var">msg</span> <span class="id" title="var">init</span> <span class="id" title="var">fin</span> <span class="id" title="var">acts</span>}:<br/>
&nbsp;&nbsp;<span class="id" title="var">map_forallb</span> (<span class="id" title="var">Z.leb</span> 0) (<span class="id" title="var">donations_coq</span> <span class="id" title="var">init</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">consistent_balance</span> <span class="id" title="var">init</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">Receive.receive</span> <span class="id" title="var">sch</span> <span class="id" title="var">sctx</span> <span class="id" title="var">msg</span> <span class="id" title="var">init</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">fin</span>, <span class="id" title="var">acts</span>) -&gt;<br/>
<br/>
&nbsp;&nbsp;((<span class="id" title="var">Ctx_amount</span> <span class="id" title="var">sctx</span> + <span class="id" title="var">init</span>.(<span class="id" title="var">balance_coq</span>) = <span class="id" title="var">fin</span>.(<span class="id" title="var">balance_coq</span>))%<span class="id" title="var">Z</span> /\ <span class="id" title="var">acts</span> = [])<br/>
<br/>
&nbsp;&nbsp;\/ ((<span class="id" title="var">fin</span>.(<span class="id" title="var">balance_coq</span>) = 0%<span class="id" title="var">Z</span>) /\ <span class="id" title="var">acts</span> = [<span class="id" title="var">Act_transfer</span> (<span class="id" title="var">Ctx_from</span> <span class="id" title="var">sctx</span>) <span class="id" title="var">init</span>.(<span class="id" title="var">balance_coq</span>)])<br/>
<br/>
&nbsp;&nbsp;\/ (<span class="id" title="tactic">exists</span> <span class="id" title="var">v</span>, <span class="id" title="var">acts</span> = [<span class="id" title="var">Act_transfer</span> <span class="id" title="var">sctx</span>.(<span class="id" title="var">Ctx_from</span>) <span class="id" title="var">v</span>] /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">v</span> &lt;= <span class="id" title="var">init</span>.(<span class="id" title="var">balance_coq</span>))%<span class="id" title="var">Z</span> /\ (<span class="id" title="var">fin</span>.(<span class="id" title="var">balance_coq</span>) = <span class="id" title="var">init</span>.(<span class="id" title="var">balance_coq</span>) - <span class="id" title="var">v</span>)%<span class="id" title="var">Z</span>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Hpos</span> <span class="id" title="var">Hbalance</span> <span class="id" title="var">Hcall</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="var">eqn</span>:<span class="id" title="var">Hmsg</span>.<br/>
&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">_</span> &lt;=? <span class="id" title="var">_</span>);<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">lookup_map</span> <span class="id" title="var">_</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion</span> <span class="id" title="var">Hcall</span>; <span class="id" title="tactic">tauto</span>.<br/>
&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">_</span> &amp;&amp; <span class="id" title="var">_</span> &amp;&amp; <span class="id" title="var">_</span>);<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion</span> <span class="id" title="var">Hcall</span>; <span class="id" title="tactic">tauto</span>.<br/>
&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">_</span> &amp;&amp; <span class="id" title="var">_</span> &amp;&amp; <span class="id" title="var">_</span>) <span class="id" title="var">eqn</span>:<span class="id" title="var">Hcond</span>;<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">lookup_map</span> <span class="id" title="var">_</span>) <span class="id" title="var">eqn</span>:<span class="id" title="var">Hlook</span>;<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion</span> <span class="id" title="var">Hcall</span>. <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">rewrite</span> <span class="id" title="var">Bool.andb_true_iff</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">Hcond</span> <span class="id" title="keyword">as</span> [[? ?] <span class="id" title="var">Hdone</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">Hbalance</span> <span class="id" title="var">Hdone</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">z</span> &lt;= <span class="id" title="var">balance_coq</span> <span class="id" title="var">init</span>)%<span class="id" title="var">Z</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">rewrite</span> &lt;- <span class="id" title="var">Hbalance</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">lookup_map_sum_map_leq</span>;<span class="id" title="tactic">eauto</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">right</span>. <span class="id" title="tactic">right</span>. <span class="id" title="tactic">eexists</span>;<span class="id" title="tactic">split</span>;<span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Local Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Hint Resolve</span> <span class="id" title="var">cf_balance_consistent</span> <span class="id" title="var">crowfunding_donations_non_negative</span> : <span class="id" title="var">core</span>.<br/>
</div>

<div class="doc">
<a name="lab225"></a><h2 class="section">The actual contract balance is consistent with the local state</h2>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">cf_backed</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> <span class="id" title="var">lstate</span>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">acts</span> := <span class="id" title="var">chain_state_queue</span> <span class="id" title="var">bstate</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">reachable</span> <span class="id" title="var">bstate</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">cf_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" title="var">env_account_balances</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> &gt;=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">balance_coq</span> <span class="id" title="var">lstate</span> + <span class="id" title="var">sumZ</span> <span class="id" title="var">act_body_amount</span> (<span class="id" title="var">outgoing_acts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span>)).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">is_reachable</span> <span class="id" title="var">is_deployed</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">revert</span> <span class="id" title="var">lstate</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">enough</span> (<span class="id" title="var">H</span>: <span class="id" title="tactic">exists</span> <span class="id" title="var">lstate'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate'</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">env_account_balances</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span> &gt;=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">balance_coq</span> <span class="id" title="var">lstate'</span> + <span class="id" title="var">sumZ</span> <span class="id" title="var">act_body_amount</span> (<span class="id" title="var">outgoing_acts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">cf_addr</span>))).<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">lstate'</span> [? ?]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">now</span> <span class="id" title="tactic">replace</span> <span class="id" title="var">lstate</span> <span class="id" title="keyword">with</span> <span class="id" title="var">lstate'</span> <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">contract_induction</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">inversion_clear</span> <span class="id" title="var">init_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">DeployFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">ctx</span> =&gt; <span class="id" title="var">ctx_amount</span> <span class="id" title="var">ctx</span> &gt;= 0);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">DeployFacts</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span>| ];<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> <span class="id" title="var">receive_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> [[? ?]| ] <span class="id" title="var">eqn</span>:<span class="id" title="var">Hreceive</span>;<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> <span class="id" title="var">receive_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> <span class="id" title="var">s</span> <span class="id" title="keyword">with</span> <span class="id" title="var">new_state</span> <span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> <span class="id" title="var">new_acts</span> <span class="id" title="keyword">with</span> (<span class="id" title="var">map</span> <span class="id" title="var">to_action_body</span> <span class="id" title="var">l</span>) <span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">instantiate</span> (<span class="id" title="var">CallFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">ctx</span> <span class="id" title="var">cstate</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">ctx_amount</span> <span class="id" title="var">ctx</span> &gt;= 0 /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">consistent_balance</span> <span class="id" title="var">cstate</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">donations_non_neg</span> <span class="id" title="var">cstate</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">CallFacts</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">facts</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">Hamt_non_neg</span> [<span class="id" title="var">Hconsistent</span> <span class="id" title="var">Hpos</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">cf_transfer_cases</span> <span class="id" title="var">Hpos</span> <span class="id" title="var">Hconsistent</span> <span class="id" title="var">Hreceive</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">cf_cases</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">receive_some</span> <span class="id" title="var">Hreceive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">cf_cases</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">H</span> | [<span class="id" title="var">H</span> | <span class="id" title="var">H</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;donate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> (<span class="id" title="var">Ctx_amount</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">ctx</span>)) <span class="id" title="keyword">with</span> (<span class="id" title="var">ctx_amount</span> <span class="id" title="var">ctx</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> (<span class="id" title="var">now</span> <span class="id" title="tactic">destruct</span> <span class="id" title="var">ctx</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;get&nbsp;funds&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;claim&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? [? ?]]]; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">msg</span>| ];<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> <span class="id" title="var">receive_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">Receive.receive</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) <span class="id" title="keyword">as</span> [[? ?]| ] <span class="id" title="var">eqn</span>:<span class="id" title="var">Hreceive</span>;<span class="id" title="var">tryfalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> <span class="id" title="var">receive_some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> <span class="id" title="var">s</span> <span class="id" title="keyword">with</span> <span class="id" title="var">new_state</span> <span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> <span class="id" title="var">new_acts</span> <span class="id" title="keyword">with</span> (<span class="id" title="var">map</span> <span class="id" title="var">to_action_body</span> <span class="id" title="var">l</span>) <span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> <span class="id" title="tactic">congruence</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">CallFacts</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">facts</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">Hamt_non_neg</span> [<span class="id" title="var">Hconsistent</span> <span class="id" title="var">Hpos</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">cf_transfer_cases</span> <span class="id" title="var">Hpos</span> <span class="id" title="var">Hconsistent</span> <span class="id" title="var">Hreceive</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">cf_cases</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">receive_some</span> <span class="id" title="var">Hreceive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">head</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span> [<span class="id" title="var">destruct_conjs</span>; <span class="id" title="tactic">congruence</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">cf_cases</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">H</span> | [<span class="id" title="var">H</span> | <span class="id" title="var">H</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;donate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">replace</span> (<span class="id" title="var">Ctx_amount</span> (<span class="id" title="var">of_contract_call_context</span> <span class="id" title="var">ctx</span>)) <span class="id" title="keyword">with</span> (<span class="id" title="var">ctx_amount</span> <span class="id" title="var">ctx</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">in</span> * <span class="id" title="tactic">by</span> (<span class="id" title="var">now</span> <span class="id" title="tactic">destruct</span> <span class="id" title="var">ctx</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;get&nbsp;funds&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;claim&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? [? ?]]]; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="var">now</span> <span class="id" title="tactic">rewrite</span> &lt;- <span class="id" title="var">perm</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">instantiate</span> (<span class="id" title="var">AddBlockFacts</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Logic.True</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unset_all</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">step</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">a</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">split</span>; <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Corollary</span> <span class="id" title="var">cf_backed_after_block</span> {<span class="id" title="var">ChainBuilder</span> : <span class="id" title="var">ChainBuilderType</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">prev</span> <span class="id" title="var">hd</span> <span class="id" title="var">acts</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> <span class="id" title="var">lstate</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">builder_add_block</span> <span class="id" title="var">prev</span> <span class="id" title="var">hd</span> <span class="id" title="var">acts</span> = <span class="id" title="var">Ok</span> <span class="id" title="var">new</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">cf_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="id" title="var">env_account_balances</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> &gt;= <span class="id" title="var">balance_coq</span> <span class="id" title="var">lstate</span>)%<span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Hnew</span> <span class="id" title="var">Hcf</span> <span class="id" title="var">Hst</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">ChainBuilder</span>;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">pose</span> (<span class="id" title="var">builder_trace</span> <span class="id" title="var">new</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">tr</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">Hr</span> : <span class="id" title="var">reachable</span> {| <span class="id" title="var">chain_state_env</span> := <span class="id" title="var">builder_env</span> <span class="id" title="var">new</span>; <span class="id" title="var">chain_state_queue</span> := [] |}) <span class="id" title="tactic">by</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="tactic">constructor</span>;<span class="id" title="tactic">eauto</span>).<br/>
&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">cf_backed</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">Hr</span> <span class="id" title="var">Hcf</span> <span class="id" title="var">Hst</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">Hbacked</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *. <span class="id" title="var">lia</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab226"></a><h2 class="section">The actual contract balance is consistent with the sum of individual contributions</h2>

</div>
<div class="code">
<span class="id" title="keyword">Corollary</span> <span class="id" title="var">cf_donations_backed_after_block</span> {<span class="id" title="var">ChainBuilder</span> : <span class="id" title="var">ChainBuilderType</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">prev</span> <span class="id" title="var">hd</span> <span class="id" title="var">acts</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> <span class="id" title="var">lstate</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">builder_add_block</span> <span class="id" title="var">prev</span> <span class="id" title="var">hd</span> <span class="id" title="var">acts</span> = <span class="id" title="var">Ok</span> <span class="id" title="var">new</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">cf_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id" title="var">cf_state</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">lstate</span> -&gt;<br/>
&nbsp;&nbsp;~~ <span class="id" title="var">lstate</span>.(<span class="id" title="var">done_coq</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id" title="var">env_account_balances</span> <span class="id" title="var">new</span> <span class="id" title="var">cf_addr</span> &gt;= <span class="id" title="var">sum_map</span> (<span class="id" title="var">lstate</span>.(<span class="id" title="var">donations_coq</span>)))%<span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Hnew</span> <span class="id" title="var">Hcf</span> <span class="id" title="var">Hst</span> <span class="id" title="var">Hdone</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">ChainBuilder</span>;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">pose</span> (<span class="id" title="var">builder_trace</span> <span class="id" title="var">new</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">tr</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">Hr</span> : <span class="id" title="var">reachable</span> {| <span class="id" title="var">chain_state_env</span> := <span class="id" title="var">builder_env</span> <span class="id" title="var">new</span>; <span class="id" title="var">chain_state_queue</span> := [] |}) <span class="id" title="tactic">by</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="tactic">constructor</span>;<span class="id" title="tactic">eauto</span>).<br/>
&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">cf_balance_consistent</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">Hr</span> <span class="id" title="var">Hcf</span> <span class="id" title="var">Hst</span> <span class="id" title="var">Hdone</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">Hconsistent</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <span class="id" title="var">Hconsistent</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">cf_backed</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">Hr</span> <span class="id" title="var">Hcf</span> <span class="id" title="var">Hst</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">Hbacked</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">cbn</span> <span class="id" title="tactic">in</span> *. <span class="id" title="var">lia</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
