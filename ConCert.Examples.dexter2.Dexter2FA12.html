<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="toc.html">Table of contents</a>
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc-header" class="toc-header">Contents:</div>
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc">
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.dexter2.Dexter2FA12</h1>

<div class="code">
</div>

<div class="doc">
<a name="lab161"></a><h1 class="section">Dexter 2 FA1.2 Liquidity token contract</h1>
 This file contains an implementation of Dexter2 liquidity contract
    https://gitlab.com/dexter2tz/dexter2tz/-/blob/1cec9d9333eba756603d6cd90ea9c70d482a5d3d/lqt_fa12.mligo
    In addition this file contains proof of functional correctness w.r.t the
    informal specification https://gitlab.com/dexter2tz/dexter2tz/-/blob/1cec9d9333eba756603d6cd90ea9c70d482a5d3d/docs/informal-spec/dexter2-lqt-fa12.md

<div class="paragraph"> </div>

    This contract is an extension of a basic FA1.2 token contract with
    an extra entrypoint that allows an admin to mint and burn tokens.
    It is used in the Dexter2 exchange paired with an instance of the
    Dexter2 CPMM contract. The purpose of this contract is to keep track
    of ownership of the exchanges funds. An user who owns x of the exchanges trading reserve.

</div>
<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Extras</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">RecordUpdate</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Blockchain</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Containers</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Monads</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Serializable</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">InterContractCommunication</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ContractCommon</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ZArith_base</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">List</span>. <span class="id" title="keyword">Import</span> <span class="id" title="var">ListNotations</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">non_zero_amount</span> (<span class="id" title="var">amt</span> : <span class="id" title="var">Z</span>) : <span class="id" title="var">bool</span>:= (0 &lt;? <span class="id" title="var">amt</span>)%<span class="id" title="var">Z</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab162"></a><h1 class="section">Contract types</h1>

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">LQTFA12Types</span>.<br/>
<span class="id" title="keyword">Context</span> {<span class="id" title="var">BaseTypes</span> : <span class="id" title="var">ChainBase</span>}.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">N_scope</span>.<br/>
<span class="id" title="keyword">Set</span> <span class="id" title="var">Nonrecursive</span> <span class="id" title="var">Elimination</span> <span class="id" title="var">Schemes</span>.<br/>

<br/>
<span class="comment">(*&nbsp;Dummy&nbsp;implementation&nbsp;of&nbsp;callbacks.&nbsp;*)</span><br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">callback</span> := {<br/>
&nbsp;&nbsp;<span class="id" title="var">return_addr</span> : <span class="id" title="var">Address</span>;<br/>
}.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">callback_addr</span> (<span class="id" title="var">c</span> : <span class="id" title="var">callback</span>) : <span class="id" title="var">Address</span> := <span class="id" title="var">c</span>.(<span class="id" title="var">return_addr</span>).<br/>
<span class="id" title="keyword">Coercion</span> <span class="id" title="var">callback_addr</span> : <span class="id" title="var">callback</span> &gt;-&gt; <span class="id" title="var">Address</span>.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">transfer_param</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_transfer_param</span>{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from</span> : <span class="id" title="var">Address</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">to</span> : <span class="id" title="var">Address</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">value</span> : <span class="id" title="var">N</span><br/>
}.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">approve_param</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_approve_param</span>{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">spender</span> : <span class="id" title="var">Address</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">value_</span> : <span class="id" title="var">N</span><br/>
}.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">mintOrBurn_param</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_mintOrBurn_param</span>{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">quantity</span> : <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">target</span> : <span class="id" title="var">Address</span><br/>
}.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">getAllowance_param</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_getAllowance_param</span>{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">request</span> : (<span class="id" title="var">Address</span> * <span class="id" title="var">Address</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">allowance_callback</span> : <span class="id" title="var">callback</span><br/>
}.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">getBalance_param</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_getBalance_param</span>{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">owner_</span> : <span class="id" title="var">Address</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">balance_callback</span> : <span class="id" title="var">callback</span><br/>
}.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">getTotalSupply_param</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_getTotalSupply_param</span>{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">request_</span> : <span class="id" title="var">unit</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">supply_callback</span> : <span class="id" title="var">callback</span><br/>
}.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">State</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_state</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">tokens</span> : <span class="id" title="var">FMap</span> <span class="id" title="var">Address</span> <span class="id" title="var">N</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">allowances</span> : <span class="id" title="var">FMap</span> (<span class="id" title="var">Address</span> * <span class="id" title="var">Address</span>) <span class="id" title="var">N</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">admin</span> : <span class="id" title="var">Address</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply</span> : <span class="id" title="var">N</span><br/>
}.<br/>

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">Setup</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_setup</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">admin_</span> : <span class="id" title="var">Address</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lqt_provider</span> : <span class="id" title="var">Address</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">initial_pool</span> : <span class="id" title="var">N</span><br/>
}.<br/>

<br/>
<span class="comment">(*&nbsp;Any&nbsp;contract&nbsp;that&nbsp;wants&nbsp;to&nbsp;receive&nbsp;callback&nbsp;messages&nbsp;from&nbsp;the&nbsp;FA1.2&nbsp;liquidity&nbsp;contract<br/>
&nbsp;&nbsp;&nbsp;should&nbsp;have&nbsp;this&nbsp;type&nbsp;as&nbsp;its&nbsp;Msg&nbsp;type.&nbsp;The&nbsp;contract&nbsp;may&nbsp;have&nbsp;other&nbsp;endpoints,<br/>
&nbsp;&nbsp;&nbsp;as&nbsp;composed&nbsp;in&nbsp;the&nbsp;'other_msg'&nbsp;constructor.&nbsp;*)</span><br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FA12ReceiverMsg</span> {<span class="id" title="var">Msg'</span> : <span class="id" title="keyword">Type</span>} :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">receive_allowance</span> : <span class="id" title="var">N</span> -&gt;  <span class="id" title="var">FA12ReceiverMsg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">receive_balance_of</span> : <span class="id" title="var">N</span> -&gt; <span class="id" title="var">FA12ReceiverMsg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">receive_total_supply</span> : <span class="id" title="var">N</span> -&gt; <span class="id" title="var">FA12ReceiverMsg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">other_msg</span> : <span class="id" title="var">Msg'</span> -&gt; <span class="id" title="var">FA12ReceiverMsg</span>.<br/>

<br/>
<span class="comment">(*&nbsp;Liquidity&nbsp;FA1.2&nbsp;Endpoints.&nbsp;*)</span><br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Msg</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">msg_transfer</span> : <span class="id" title="var">transfer_param</span> -&gt; <span class="id" title="var">Msg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">msg_approve</span> : <span class="id" title="var">approve_param</span> -&gt; <span class="id" title="var">Msg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">msg_mint_or_burn</span> : <span class="id" title="var">mintOrBurn_param</span> -&gt; <span class="id" title="var">Msg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">msg_get_allowance</span> : <span class="id" title="var">getAllowance_param</span> -&gt; <span class="id" title="var">Msg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">msg_get_balance</span> : <span class="id" title="var">getBalance_param</span> -&gt; <span class="id" title="var">Msg</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">msg_get_total_supply</span> : <span class="id" title="var">getTotalSupply_param</span> -&gt; <span class="id" title="var">Msg</span>.<br/>

<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">mintedOrBurnedTokens</span> (<span class="id" title="var">msg</span> : <span class="id" title="var">option</span> <span class="id" title="var">Msg</span>) : <span class="id" title="var">Z</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">msg_mint_or_burn</span> <span class="id" title="var">param</span>) =&gt; <span class="id" title="var">param</span>.(<span class="id" title="var">quantity</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; 0<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Class</span> <span class="id" title="var">LqtTokenInterface</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<span class="id" title="var">Serializable</span> <span class="id" title="var">State</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<span class="id" title="var">Serializable</span> <span class="id" title="var">Msg</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<span class="id" title="var">Serializable</span> <span class="id" title="var">Setup</span>} :=<br/>
&nbsp;&nbsp;{ <span class="id" title="var">lqt_contract</span> : <span class="id" title="var">Contract</span> <span class="id" title="var">Setup</span> <span class="id" title="var">Msg</span> <span class="id" title="var">State</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lqt_total_supply_correct</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">forall</span>  (<span class="id" title="var">bstate</span> : <span class="id" title="var">ChainState</span>) (<span class="id" title="var">caddr</span> : <span class="id" title="var">Address</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">trace</span> : <span class="id" title="var">ChainTrace</span> <span class="id" title="var">empty_state</span> <span class="id" title="var">bstate</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">env_contracts</span> <span class="id" title="var">bstate</span> <span class="id" title="var">caddr</span> = <span class="id" title="var">Some</span> (<span class="id" title="var">lqt_contract</span> : <span class="id" title="var">WeakContract</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">exists</span> (<span class="id" title="var">cstate</span> : <span class="id" title="var">State</span>) (<span class="id" title="var">depinfo</span> : <span class="id" title="var">DeploymentInfo</span> <span class="id" title="var">Setup</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">inc_calls</span> : <span class="id" title="var">list</span> (<span class="id" title="var">ContractCallInfo</span> <span class="id" title="var">Msg</span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">contract_state</span> <span class="id" title="var">bstate</span> <span class="id" title="var">caddr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">cstate</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">deployment_info</span> <span class="id" title="var">Setup</span> <span class="id" title="var">trace</span> <span class="id" title="var">caddr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">depinfo</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">incoming_calls</span> <span class="id" title="var">Msg</span> <span class="id" title="var">trace</span> <span class="id" title="var">caddr</span> = <span class="id" title="var">Some</span> <span class="id" title="var">inc_calls</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">let</span> <span class="id" title="var">initial_tokens</span> := <span class="id" title="var">initial_pool</span> (<span class="id" title="var">deployment_setup</span> <span class="id" title="var">depinfo</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Z.of_N</span> (<span class="id" title="var">total_supply</span> <span class="id" title="var">cstate</span>) =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Z.of_N</span> <span class="id" title="var">initial_tokens</span> +<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">sumZ</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">callInfo</span>  =&gt; <span class="id" title="var">mintedOrBurnedTokens</span> (<span class="id" title="var">call_msg</span> <span class="id" title="var">callInfo</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">filter</span> (<span class="id" title="var">callFrom</span> (<span class="id" title="var">admin</span> <span class="id" title="var">cstate</span>)) <span class="id" title="var">inc_calls</span>))%<span class="id" title="var">Z</span>) }.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">LQTFA12Types</span>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="keyword">Type</span> <span class="id" title="var">Dexter2LqtSerializable</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Section</span> <span class="id" title="var">D2LqtSerializable</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Context</span> `{<span class="id" title="var">ChainBase</span>}.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">callback_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">callback</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">transfer_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">transfer_param</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">approve_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">approve_param</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">mintOrBurn_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">mintOrBurn_param</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">getAllowance_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">getAllowance_param</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">getBalance_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">getBalance_param</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">getTotalSupply_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">getTotalSupply_param</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">FA12ReceiverMsg_serializable</span> : <span class="id" title="keyword">forall</span> {<span class="id" title="var">Msg</span> : <span class="id" title="keyword">Type</span>} `{<span class="id" title="var">Serializable</span> <span class="id" title="var">Msg</span>}, <span class="id" title="var">Serializable</span> (@<span class="id" title="var">FA12ReceiverMsg</span> <span class="id" title="var">Msg</span>).<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">msg_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">Msg</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">state_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">State</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Axiom</span> <span class="id" title="var">setup_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">Setup</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">End</span> <span class="id" title="var">D2LqtSerializable</span>.<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">Dexter2LqtSerializable</span>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">D2LqtSInstances</span> &lt;: <span class="id" title="var">Dexter2LqtSerializable</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Section</span> <span class="id" title="var">Serialization</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Context</span> `{<span class="id" title="var">ChainBase</span>}.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">callback_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">callback</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">callback_rect</span> &lt;<span class="id" title="var">Build_callback</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">transfer_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">transfer_param</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">transfer_param_rect</span> &lt;<span class="id" title="var">build_transfer_param</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">approve_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">approve_param</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">approve_param_rect</span> &lt;<span class="id" title="var">build_approve_param</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">mintOrBurn_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">mintOrBurn_param</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">mintOrBurn_param_rect</span> &lt;<span class="id" title="var">build_mintOrBurn_param</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">getAllowance_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">getAllowance_param</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">getAllowance_param_rect</span> &lt;<span class="id" title="var">build_getAllowance_param</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">getBalance_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">getBalance_param</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">getBalance_param_rect</span> &lt;<span class="id" title="var">build_getBalance_param</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">getTotalSupply_param_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">getTotalSupply_param</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">getTotalSupply_param_rect</span> &lt;<span class="id" title="var">build_getTotalSupply_param</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">FA12ReceiverMsg_serializable</span> {<span class="id" title="var">Msg</span> : <span class="id" title="keyword">Type</span>} `{<span class="id" title="var">Serializable</span> <span class="id" title="var">Msg</span>} : <span class="id" title="var">Serializable</span> (@<span class="id" title="var">FA12ReceiverMsg</span> <span class="id" title="var">Msg</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> (@<span class="id" title="var">FA12ReceiverMsg_rect</span> <span class="id" title="var">Msg</span>) &lt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id" title="var">receive_allowance</span> <span class="id" title="var">Msg</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id" title="var">receive_balance_of</span> <span class="id" title="var">Msg</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id" title="var">receive_total_supply</span> <span class="id" title="var">Msg</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id" title="var">other_msg</span> <span class="id" title="var">Msg</span>)&gt;.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">msg_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">Msg</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">Msg_rect</span> &lt;<span class="id" title="var">msg_transfer</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg_approve</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg_mint_or_burn</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg_get_allowance</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg_get_balance</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg_get_total_supply</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">state_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">State</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">State_rect</span> &lt;<span class="id" title="var">build_state</span>&gt;.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Instance</span> <span class="id" title="var">setup_serializable</span> : <span class="id" title="var">Serializable</span> <span class="id" title="var">Setup</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Derive</span> <span class="id" title="var">Serializable</span> <span class="id" title="var">Setup_rect</span> &lt;<span class="id" title="var">build_setup</span>&gt;.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">End</span> <span class="id" title="var">Serialization</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">D2LqtSInstances</span>.<br/>
<span class="comment">(*&nbsp;end&nbsp;hide&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
<a name="lab163"></a><h1 class="section">Contract functions</h1>

</div>
<div class="code">
<span class="id" title="keyword">Module</span> <span class="id" title="var">Dexter2Lqt</span> (<span class="id" title="var">SI</span> : <span class="id" title="var">Dexter2LqtSerializable</span>).<br/>

<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">SI</span>.<br/>

<br/>

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">DexterLqtDefs</span>.<br/>
<span class="id" title="keyword">Context</span> `{<span class="id" title="var">BaseTypes</span> : <span class="id" title="var">ChainBase</span>}.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">N_scope</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">find_allowance</span> (<span class="id" title="var">k</span> : <span class="id" title="var">Address</span> * <span class="id" title="var">Address</span>) (<span class="id" title="var">m</span> : <span class="id" title="var">FMap</span> (<span class="id" title="var">Address</span> * <span class="id" title="var">Address</span>) <span class="id" title="var">N</span>) : <span class="id" title="var">option</span> <span class="id" title="var">N</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">FMap.find</span> <span class="id" title="var">k</span> <span class="id" title="var">m</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">update_allowance</span> (<span class="id" title="var">k</span> : <span class="id" title="var">Address</span> * <span class="id" title="var">Address</span>) (<span class="id" title="var">val</span> : <span class="id" title="var">option</span> <span class="id" title="var">N</span>) (<span class="id" title="var">m</span> : <span class="id" title="var">FMap</span> (<span class="id" title="var">Address</span> * <span class="id" title="var">Address</span>) <span class="id" title="var">N</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">FMap.update</span> <span class="id" title="var">k</span> <span class="id" title="var">val</span> <span class="id" title="var">m</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">empty_allowance</span> : <span class="id" title="var">FMap</span> (<span class="id" title="var">Address</span> * <span class="id" title="var">Address</span>) <span class="id" title="var">N</span> := <span class="id" title="var">FMap.empty</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab164"></a><h2 class="section">Transfer</h2>
 Transfers <span class="inlinecode"><span class="id" title="projection">amount</span></span> tokens, if <span class="inlinecode"><span class="id" title="projection">from</span></span> has enough tokens to transfer
    and <span class="inlinecode"><span class="id" title="variable">sender</span></span> is allowed to send that much on behalf of <span class="inlinecode"><span class="id" title="projection">from</span></span> 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">try_transfer</span> (<span class="id" title="var">sender</span> : <span class="id" title="var">Address</span>) (<span class="id" title="var">param</span> : <span class="id" title="var">transfer_param</span>) (<span class="id" title="var">state</span> : <span class="id" title="var">State</span>) : <span class="id" title="var">option</span> <span class="id" title="var">State</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowances_</span> := <span class="id" title="var">state</span>.(<span class="id" title="var">allowances</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">tokens_</span> := <span class="id" title="var">state</span>.(<span class="id" title="var">tokens</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">allowances_</span> &lt;- <span class="comment">(*&nbsp;Update&nbsp;allowances&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">if</span> <span class="id" title="var">address_eqb</span> <span class="id" title="var">sender</span> <span class="id" title="var">param</span>.(<span class="id" title="var">from</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">allowances_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowance_key</span> := (<span class="id" title="var">param</span>.(<span class="id" title="var">from</span>), <span class="id" title="var">sender</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">authorized_value</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">find_allowance</span> <span class="id" title="var">allowance_key</span> <span class="id" title="var">allowances_</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">throwIf</span> (<span class="id" title="var">authorized_value</span> &lt;? <span class="id" title="var">param</span>.(<span class="id" title="var">value</span>)) ; <span class="comment">(*&nbsp;NotEnoughAllowance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">update_allowance</span> <span class="id" title="var">allowance_key</span> (<span class="id" title="var">maybe</span> (<span class="id" title="var">authorized_value</span> - <span class="id" title="var">param</span>.(<span class="id" title="var">value</span>))) <span class="id" title="var">allowances_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;) ;<br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">tokens_</span> &lt;- <span class="comment">(*&nbsp;Update&nbsp;from&nbsp;balance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">let</span> <span class="id" title="var">from_balance</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">AddressMap.find</span> <span class="id" title="var">param</span>.(<span class="id" title="var">from</span>) <span class="id" title="var">tokens_</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">throwIf</span> (<span class="id" title="var">from_balance</span> &lt;? <span class="id" title="var">param</span>.(<span class="id" title="var">value</span>)) ; <span class="comment">(*&nbsp;NotEnoughBalance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">AddressMap.update</span> <span class="id" title="var">param</span>.(<span class="id" title="var">from</span>) (<span class="id" title="var">maybe</span> (<span class="id" title="var">from_balance</span> - <span class="id" title="var">param</span>.(<span class="id" title="var">value</span>))) <span class="id" title="var">tokens_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;) ;<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">tokens_</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">AddressMap.find</span> <span class="id" title="var">param</span>.(<span class="id" title="var">to</span>) <span class="id" title="var">tokens_</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">AddressMap.update</span> <span class="id" title="var">param</span>.(<span class="id" title="var">to</span>) (<span class="id" title="var">maybe</span> (<span class="id" title="var">to_balance</span> + <span class="id" title="var">param</span>.(<span class="id" title="var">value</span>))) <span class="id" title="var">tokens_</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">state</span>&lt;|<span class="id" title="var">tokens</span> := <span class="id" title="var">tokens_</span>|&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;|<span class="id" title="var">allowances</span> := <span class="id" title="var">allowances_</span>|&gt;).<br/>

<br/>
</div>

<div class="doc">
<a name="lab165"></a><h2 class="section">Approve</h2>
 The caller approves the <span class="inlinecode"><span class="id" title="projection">spender</span></span> to transfer up to <span class="inlinecode"><span class="id" title="projection">amount</span></span> tokens on behalf of the <span class="inlinecode"><span class="id" title="variable">sender</span></span> 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">try_approve</span> (<span class="id" title="var">sender</span> : <span class="id" title="var">Address</span>) (<span class="id" title="var">param</span> : <span class="id" title="var">approve_param</span>) (<span class="id" title="var">state</span> : <span class="id" title="var">State</span>) : <span class="id" title="var">option</span> <span class="id" title="var">State</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowances_</span> := <span class="id" title="var">state</span>.(<span class="id" title="var">allowances</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowance_key</span> := (<span class="id" title="var">sender</span>, <span class="id" title="var">param</span>.(<span class="id" title="var">spender</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">previous_value</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">find_allowance</span> <span class="id" title="var">allowance_key</span> <span class="id" title="var">allowances_</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">throwIf</span> (<span class="id" title="var">andb</span> (0 &lt;? <span class="id" title="var">previous_value</span>) (0 &lt;? <span class="id" title="var">param</span>.(<span class="id" title="var">value_</span>))) ; <span class="comment">(*&nbsp;UnsafeAllowanceChange&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">allowances_</span> := <span class="id" title="var">update_allowance</span> <span class="id" title="var">allowance_key</span> (<span class="id" title="var">maybe</span> <span class="id" title="var">param</span>.(<span class="id" title="var">value_</span>)) <span class="id" title="var">allowances_</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">state</span>&lt;|<span class="id" title="var">allowances</span> := <span class="id" title="var">allowances_</span>|&gt;).<br/>

<br/>
</div>

<div class="doc">
<a name="lab166"></a><h2 class="section">Mint or burn</h2>
 If <span class="inlinecode"><span class="id" title="projection">quantity</span></span> is positive
    then creates <span class="inlinecode"><span class="id" title="projection">quantity</span></span> tokens and gives them to <span class="inlinecode"><span class="id" title="projection">target</span></span>
    else removes <span class="inlinecode"><span class="id" title="projection">quantity</span></span> tokens from <span class="inlinecode"><span class="id" title="projection">target</span></span>.
    Can only be called by <span class="inlinecode"><span class="id" title="projection">admin</span></span> 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">try_mint_or_burn</span> (<span class="id" title="var">sender</span> : <span class="id" title="var">Address</span>) (<span class="id" title="var">param</span> : <span class="id" title="var">mintOrBurn_param</span>) (<span class="id" title="var">state</span> : <span class="id" title="var">State</span>) : <span class="id" title="var">option</span> <span class="id" title="var">State</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">throwIf</span> (<span class="id" title="var">negb</span> (<span class="id" title="var">address_eqb</span> <span class="id" title="var">sender</span> <span class="id" title="var">state</span>.(<span class="id" title="var">admin</span>))) ;<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">tokens_</span> := <span class="id" title="var">state</span>.(<span class="id" title="var">tokens</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">old_balance</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">AddressMap.find</span> <span class="id" title="var">param</span>.(<span class="id" title="var">target</span>) <span class="id" title="var">tokens_</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_balance</span> := (<span class="id" title="var">Z.of_N</span> <span class="id" title="var">old_balance</span> + <span class="id" title="var">param</span>.(<span class="id" title="var">quantity</span>))%<span class="id" title="var">Z</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">throwIf</span> (<span class="id" title="var">new_balance</span> &lt;? 0)%<span class="id" title="var">Z</span> ; <span class="comment">(*&nbsp;Cannot&nbsp;burn&nbsp;more&nbsp;than&nbsp;the&nbsp;target's&nbsp;balance.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">tokens_</span> := <span class="id" title="var">AddressMap.update</span> <span class="id" title="var">param</span>.(<span class="id" title="var">target</span>) (<span class="id" title="var">maybe</span> (<span class="id" title="var">Z.to_N</span> <span class="id" title="var">new_balance</span>)) <span class="id" title="var">tokens_</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">total_supply_</span> := <span class="id" title="var">Z.abs_N</span> (<span class="id" title="var">Z.of_N</span> <span class="id" title="var">state</span>.(<span class="id" title="var">total_supply</span>) + <span class="id" title="var">param</span>.(<span class="id" title="var">quantity</span>))%<span class="id" title="var">Z</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">state</span>&lt;|<span class="id" title="var">tokens</span> := <span class="id" title="var">tokens_</span>|&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;|<span class="id" title="var">total_supply</span> := <span class="id" title="var">total_supply_</span>|&gt;).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">mk_callback</span> (<span class="id" title="var">to_addr</span> : <span class="id" title="var">Address</span>) (<span class="id" title="var">msg</span> : @<span class="id" title="var">FA12ReceiverMsg</span> <span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">act_call</span> <span class="id" title="var">to_addr</span> 0 (<span class="id" title="var">serialize</span> <span class="id" title="var">msg</span>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">receive_allowance_</span> <span class="id" title="var">n</span> := @<span class="id" title="var">receive_allowance</span> <span class="id" title="var">unit</span> <span class="id" title="var">n</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">receive_balance_of_</span> <span class="id" title="var">n</span> := @<span class="id" title="var">receive_balance_of</span> <span class="id" title="var">unit</span> <span class="id" title="var">n</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">receive_total_supply_</span> <span class="id" title="var">n</span> := @<span class="id" title="var">receive_total_supply</span> <span class="id" title="var">unit</span> <span class="id" title="var">n</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab167"></a><h2 class="section">Get allowance</h2>
 Get the quantity that <span class="inlinecode"><a class="idref" href="http://coq.inria.fr/distrib/V8.11.2/stdlib//Coq.Init.Datatypes.html#snd"><span class="id" title="definition">snd</span></a></span> <span class="inlinecode"><span class="id" title="projection">request</span></span> is allowed to spend on behalf of <span class="inlinecode"><a class="idref" href="http://coq.inria.fr/distrib/V8.11.2/stdlib//Coq.Init.Datatypes.html#fst"><span class="id" title="definition">fst</span></a></span> <span class="inlinecode"><span class="id" title="projection">request</span></span> 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">try_get_allowance</span> (<span class="id" title="var">sender</span> : <span class="id" title="var">Address</span>) (<span class="id" title="var">param</span> : <span class="id" title="var">getAllowance_param</span>) (<span class="id" title="var">state</span> : <span class="id" title="var">State</span>) : <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">value</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">find_allowance</span> <span class="id" title="var">param</span>.(<span class="id" title="var">request</span>) <span class="id" title="var">state</span>.(<span class="id" title="var">allowances</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" title="var">mk_callback</span> <span class="id" title="var">param</span>.(<span class="id" title="var">allowance_callback</span>) (<span class="id" title="var">receive_allowance_</span> <span class="id" title="var">value</span>)].<br/>

<br/>
</div>

<div class="doc">
<a name="lab168"></a><h2 class="section">Get balance</h2>
 Get the quantity of tokens belonging to <span class="inlinecode"><span class="id" title="projection">owner</span></span> 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">try_get_balance</span> (<span class="id" title="var">sender</span> : <span class="id" title="var">Address</span>) (<span class="id" title="var">param</span> : <span class="id" title="var">getBalance_param</span>) (<span class="id" title="var">state</span> : <span class="id" title="var">State</span>) : <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">value</span> := <span class="id" title="var">with_default</span> 0 (<span class="id" title="var">AddressMap.find</span> <span class="id" title="var">param</span>.(<span class="id" title="var">owner_</span>) <span class="id" title="var">state</span>.(<span class="id" title="var">tokens</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" title="var">mk_callback</span> <span class="id" title="var">param</span>.(<span class="id" title="var">balance_callback</span>) (<span class="id" title="var">receive_balance_of_</span> <span class="id" title="var">value</span>)].<br/>

<br/>
</div>

<div class="doc">
<a name="lab169"></a><h2 class="section">Get total supply</h2>
 Get the total supply of tokens 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">try_get_total_supply</span> (<span class="id" title="var">sender</span> : <span class="id" title="var">Address</span>) (<span class="id" title="var">param</span> : <span class="id" title="var">getTotalSupply_param</span>) (<span class="id" title="var">state</span> : <span class="id" title="var">State</span>) : <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">value</span> := <span class="id" title="var">state</span>.(<span class="id" title="var">total_supply</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" title="var">mk_callback</span> <span class="id" title="var">param</span>.(<span class="id" title="var">supply_callback</span>) (<span class="id" title="var">receive_total_supply_</span> <span class="id" title="var">value</span>)].<br/>

<br/>
</div>

<div class="doc">
<a name="lab170"></a><h2 class="section">Init</h2>
 Initalize contract storage 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_lqt</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">ctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">setup</span> : <span class="id" title="var">Setup</span>) : <span class="id" title="var">option</span> <span class="id" title="var">State</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">Some</span> {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">tokens</span> := <span class="id" title="var">AddressMap.add</span> <span class="id" title="var">setup</span>.(<span class="id" title="var">lqt_provider</span>) <span class="id" title="var">setup</span>.(<span class="id" title="var">initial_pool</span>) <span class="id" title="var">AddressMap.empty</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">allowances</span> := <span class="id" title="var">empty_allowance</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">admin</span> := <span class="id" title="var">setup</span>.(<span class="id" title="var">admin_</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">total_supply</span> := <span class="id" title="var">setup</span>.(<span class="id" title="var">initial_pool</span>);<br/>
&nbsp;&nbsp;|}.<br/>

<br/>
</div>

<div class="doc">
<a name="lab171"></a><h2 class="section">Receive</h2>
 Contract main entrypoint 
</div>
<div class="code">
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">receive_lqt</span> (<span class="id" title="var">chain</span> : <span class="id" title="var">Chain</span>) (<span class="id" title="var">ctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">state</span> : <span class="id" title="var">State</span>) (<span class="id" title="var">maybe_msg</span> : <span class="id" title="var">option</span> <span class="id" title="var">Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">option</span> (<span class="id" title="var">State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">sender</span> := <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">without_actions</span> := <span class="id" title="var">option_map</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">new_state</span> =&gt; (<span class="id" title="var">new_state</span>, [])) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">without_statechange</span> <span class="id" title="var">acts</span> := <span class="id" title="var">Some</span> (<span class="id" title="var">state</span>, <span class="id" title="var">acts</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">throwIf</span> (<span class="id" title="var">non_zero_amount</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_amount</span>)); <span class="comment">(*&nbsp;DontSendTez&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">maybe_msg</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">msg_transfer</span> <span class="id" title="var">param</span>) =&gt; <span class="id" title="var">without_actions</span> (<span class="id" title="var">try_transfer</span> <span class="id" title="var">sender</span> <span class="id" title="var">param</span> <span class="id" title="var">state</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">msg_approve</span> <span class="id" title="var">param</span>) =&gt; <span class="id" title="var">without_actions</span> (<span class="id" title="var">try_approve</span> <span class="id" title="var">sender</span> <span class="id" title="var">param</span> <span class="id" title="var">state</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">msg_mint_or_burn</span> <span class="id" title="var">param</span>) =&gt; <span class="id" title="var">without_actions</span> (<span class="id" title="var">try_mint_or_burn</span> <span class="id" title="var">sender</span> <span class="id" title="var">param</span> <span class="id" title="var">state</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">msg_get_allowance</span> <span class="id" title="var">param</span>) =&gt; <span class="id" title="var">without_statechange</span> (<span class="id" title="var">try_get_allowance</span> <span class="id" title="var">sender</span> <span class="id" title="var">param</span> <span class="id" title="var">state</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">msg_get_balance</span> <span class="id" title="var">param</span>) =&gt; <span class="id" title="var">without_statechange</span> (<span class="id" title="var">try_get_balance</span> <span class="id" title="var">sender</span> <span class="id" title="var">param</span> <span class="id" title="var">state</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">msg_get_total_supply</span> <span class="id" title="var">param</span>) =&gt; <span class="id" title="var">without_statechange</span> (<span class="id" title="var">try_get_total_supply</span> <span class="id" title="var">sender</span> <span class="id" title="var">param</span> <span class="id" title="var">state</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">None</span> <span class="comment">(*&nbsp;Transfer&nbsp;actions&nbsp;to&nbsp;this&nbsp;contract&nbsp;are&nbsp;not&nbsp;allowed&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">Close</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">contract</span> : <span class="id" title="var">Contract</span> <span class="id" title="var">Setup</span> <span class="id" title="var">Msg</span> <span class="id" title="var">State</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">build_contract</span> <span class="id" title="var">init_lqt</span> <span class="id" title="var">receive_lqt</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">End</span> <span class="id" title="var">DexterLqtDefs</span>.<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">Dexter2Lqt</span>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">DEX2LQT</span> := <span class="id" title="var">Dexter2Lqt</span> <span class="id" title="var">D2LqtSInstances</span>.<br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
